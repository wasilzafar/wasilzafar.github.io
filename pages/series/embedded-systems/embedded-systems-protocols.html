<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="robots" content="index, archive" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Master embedded communication protocols: UART, SPI, I2C, CAN bus, and USB. Deep dive into protocol implementation, timing analysis, and hardware interfacing." />
    <meta name="author" content="Wasil Zafar" />
    <meta name="keywords" content="UART, SPI, I2C, CAN bus, USB, serial communication, embedded protocols, hardware interfacing, protocol analysis, embedded systems" />
    <meta property="og:title" content="Embedded Systems Series Part 4: Communication Protocols Deep Dive" />
    <meta property="og:description" content="Master embedded communication protocols: UART, SPI, I2C, CAN bus, and USB implementation and analysis." />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2026-01-25" />
    <meta property="article:author" content="Wasil Zafar" />
    <meta property="article:section" content="Technology" />
    
    <title>Embedded Systems Series Part 4: Communication Protocols Deep Dive - Wasil Zafar</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" />
    
    <!-- Prism.js Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" id="prism-theme" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" id="prism-default" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" id="prism-dark" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-twilight.min.css" id="prism-twilight" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" id="prism-okaidia" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-solarizedlight.min.css" id="prism-solarizedlight" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" />

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../../images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../images/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="../../../images/favicon_io/site.webmanifest">

    <!-- Google Consent Mode v2 -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'analytics_storage': 'denied',
            'region': ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE']
        });
        
        gtag('consent', 'default', {
            'ad_storage': 'granted',
            'ad_user_data': 'granted',
            'ad_personalization': 'granted',
            'analytics_storage': 'granted'
        });
        
        gtag('set', 'url_passthrough', true);
    </script>

    <!-- Google Tag Manager -->
    <script>
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-PBS8M2JR');
    </script>
    
    </head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PBS8M2JR" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <!-- GDPR Cookie Consent Banner -->
    <div id="cookieBanner" class="light display-bottom" style="display: none;">
        <div id="closeIcon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"></path></svg></div>
        <div class="content-wrap">
            <div class="msg-wrap">
                <div class="title-wrap">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20"><path fill="#3B9797" d="M510.52 255.82c-69.97-.85-126.47-57.69-126.47-127.86-70.17 0-127-56.49-127.86-126.45-27.26-4.14-55.13.3-79.72 12.82l-69.13 35.22a132.221 132.221 0 0 0-57.79 57.81l-35.1 68.88a132.645 132.645 0 0 0-12.82 80.95l12.08 76.27a132.521 132.521 0 0 0 37.16 70.37l54.64 54.64a132.036 132.036 0 0 0 70.37 37.16l76.27 12.15c27.51 4.36 55.7-.11 80.95-12.8l68.88-35.08a132.166 132.166 0 0 0 57.79-57.81l35.1-68.88c12.56-24.64 17.01-52.58 12.91-79.91zM176 368c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm32-160c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm160 128c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32z"></path></svg>
                    <h4 style="margin: 0; font-size: 18px; color: var(--color-navy); font-weight: 700;">Cookie Consent</h4>
                </div>
                <p style="font-size: 14px; line-height: 1.6; color: var(--color-navy); margin-bottom: 15px;">We use cookies to enhance your browsing experience. See our <a href="/privacy-policy.html" style="color: var(--color-teal);">Privacy Policy</a> for more information.</p>
            </div>
            <div class="btn-wrap">
                <button id="cookieAccept" style="background: var(--color-teal); color: white; font-weight: 600;">Accept All</button>
                <button id="cookieReject" style="background: transparent; color: var(--color-navy); border: 2px solid var(--color-teal); font-weight: 600;">Reject All</button>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/"><span class="gradient-text">Wasil Zafar</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#skills">Skills</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#certifications">Certifications</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#interests">Interests</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="blog-hero">
        <div class="container py-5">
            <div class="blog-header">
                <a href="/pages/categories/technology.html" class="back-link">
                    <i class="fas fa-arrow-left me-2"></i>Back to Technology
                </a>
                <h1 class="display-4 fw-bold mb-3">Embedded Systems Series Part 4: Communication Protocols Deep Dive</h1>
                <div class="blog-meta">
                    <span><i class="fas fa-calendar me-2"></i>January 25, 2026</span>
                    <span><i class="fas fa-user me-2"></i>Wasil Zafar</span>
                    <span class="reading-time"><i class="fas fa-clock me-1"></i>60 min read</span>
                    <button onclick="window.print()" class="print-btn" title="Print this article"><i class="fas fa-print"></i> Print</button>
                </div>
                <p class="lead">Master UART, SPI, I2C, CAN bus, and USB—understand when to use each protocol and implement them with confidence.</p>
            </div>
        </div>
    </section>

    <!-- Table of Contents Toggle Button -->
    <button class="toc-toggle-btn" onclick="openNav()" title="Table of Contents"><i class="fas fa-list"></i></button>

    <!-- Side Navigation Overlay -->
    <div id="tocSidenav" class="sidenav-toc">
        <div class="toc-header">
            <h3><i class="fas fa-list me-2"></i>Table of Contents</h3>
            <button class="closebtn" onclick="closeNav()">&times;</button>
        </div>
        <ol>
            <li><a href="#introduction" onclick="closeNav()">Introduction to Serial Communication</a></li>
            <li><a href="#uart" onclick="closeNav()">UART Protocol</a></li>
            <li><a href="#spi" onclick="closeNav()">SPI Protocol</a></li>
            <li><a href="#i2c" onclick="closeNav()">I2C Protocol</a></li>
            <li><a href="#can" onclick="closeNav()">CAN Bus Protocol</a></li>
            <li><a href="#usb" onclick="closeNav()">USB Protocol</a></li>
            <li><a href="#comparison" onclick="closeNav()">Protocol Comparison</a></li>
            <li><a href="#implementation" onclick="closeNav()">Implementation Examples</a></li>
            <li><a href="#debugging" onclick="closeNav()">Protocol Debugging Tools</a></li>
            <li><a href="#conclusion" onclick="closeNav()">Conclusion & Next Steps</a></li>
        </ol>
    </div>

    <div id="tocOverlay" class="sidenav-overlay" onclick="closeNav()"></div>

    <!-- Main Content -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="blog-content">
                        <div id="introduction" class="blog-content">
                            <h2><i class="fas fa-network-wired me-2 text-teal"></i>Introduction to Serial Communication</h2>
                            
                            <div class="highlight-box" style="background: rgba(191, 9, 47, 0.1); border-left-color: var(--color-crimson);">
                                <i class="fas fa-book me-2"></i>
                                <strong>Series Navigation:</strong> This is Part 4 of the 12-part Embedded Systems Series. <a href="embedded-systems-rtos.html">Review Part 3: RTOS Fundamentals</a> first.
                            </div>

                            <div class="experiment-card">
                                <h4><i class="fas fa-map-signs me-2"></i>Complete Series Navigation</h4>
                                <div class="card-meta mb-2">
                                    <span class="badge bg-teal me-2">12-Part Series</span>
                                    <span class="badge bg-crimson">Embedded Systems Mastery</span>
                                </div>
                                <div class="content">
                                    <ol>
                                        <li><a href="embedded-systems-fundamentals.html">Fundamentals & Architecture</a> - Microcontrollers, memory, interrupts</li>
                                        <li><a href="embedded-systems-stm32-arm.html">STM32 & ARM Cortex-M Development</a> - ARM architecture, peripherals, HAL</li>
                                        <li><a href="embedded-systems-rtos.html">RTOS Fundamentals (FreeRTOS/Zephyr)</a> - Task management, scheduling, synchronization</li>
                                        <li><strong>Communication Protocols (This Guide)</strong> - UART, SPI, I2C, CAN, USB</li>
                                        <li><a href="embedded-systems-linux-fundamentals.html">Embedded Linux Fundamentals</a> - Linux kernel, userspace, filesystem</li>
                                        <li><a href="embedded-systems-uboot.html">U-Boot Bootloader Mastery</a> - Boot process, configuration, customization</li>
                                        <li><a href="embedded-systems-device-drivers.html">Linux Device Drivers</a> - Character, block, network drivers</li>
                                        <li><a href="embedded-systems-kernel.html">Linux Kernel Customization</a> - Kernel configuration, modules, debugging</li>
                                        <li><a href="embedded-systems-android-architecture.html">Android System Architecture</a> - Android layers, services, framework</li>
                                        <li><a href="embedded-systems-android-hal.html">Android HAL & Native Development</a> - HAL interfaces, NDK, JNI</li>
                                        <li><a href="embedded-systems-android-bsp.html">Android BSP & Kernel</a> - BSP development, kernel integration</li>
                                        <li><a href="embedded-systems-debugging.html">Debugging & Optimization</a> - JTAG, GDB, profiling, optimization</li>
                                    </ol>
                                </div>
                            </div>
                                
                            <p>Communication protocols are the <strong>nervous system of embedded devices</strong>—they connect MCUs to sensors, displays, memory, and other systems. Understanding when to use UART vs. SPI vs. I2C (and why) separates hobbyists from professional embedded engineers.</p>

                            <h3>Serial vs. Parallel Communication</h3>

                            <p><strong>Serial communication</strong> sends data one bit at a time over fewer wires. While seemingly slower than parallel (which sends multiple bits simultaneously), serial protocols dominate embedded systems because:</p>

                            <ul>
                                <li><strong>Fewer pins:</strong> MCUs have limited I/O; serial needs 1-4 wires vs. 8-16 for parallel</li>
                                <li><strong>Simpler PCB routing:</strong> Less crosstalk, easier layout</li>
                                <li><strong>Higher speeds possible:</strong> Modern serial can exceed 10 Gbps</li>
                                <li><strong>Longer distances:</strong> Differential signals (CAN, RS-485) span kilometers</li>
                            </ul>

                            <h2 id="uart"><i class="fas fa-code me-2 text-teal"></i>UART Protocol</h2>

                            <p><strong>UART (Universal Asynchronous Receiver/Transmitter)</strong> is the simplest serial protocol—no clock line, point-to-point communication. Essential for debugging (printf), GPS modules, and Bluetooth modules.</p>

                            <div class="experiment-card">
                                <h4><i class="fas fa-wave-square me-2"></i>UART Frame Structure</h4>
                                <div class="card-meta mb-2">
                                    <span class="badge bg-teal">Asynchronous</span>
                                    <span class="badge bg-navy">Full Duplex</span>
                                    <span class="badge bg-crimson">2 Wires (TX/RX)</span>
                                </div>
                                <div class="content">
                                    <pre>
   IDLE  START   D0   D1   D2   D3   D4   D5   D6   D7  PARITY  STOP
    ___   ___   ___   ___   ___   ___   ___   ___   ___   ___   ___
       \_/   \_/   \_/   \_/   \_/   \_/   \_/   \_/   \_/   \_/   \____
       |     |<----------- 8 data bits ---------->|     |
       |                                           |     |
    Start bit                              Optional    Stop bit(s)
    (always 0)                              Parity     (always 1)
                                    </pre>
                                    <p><strong>Common configurations:</strong> 115200 baud, 8N1 (8 data bits, no parity, 1 stop bit)</p>
                                </div>
                            </div>

<pre><code class="language-c">// STM32 HAL UART - Basic usage
UART_HandleTypeDef huart2;

void MX_USART2_UART_Init(void) {
    huart2.Instance = USART2;
    huart2.Init.BaudRate = 115200;
    huart2.Init.WordLength = UART_WORDLENGTH_8B;
    huart2.Init.StopBits = UART_STOPBITS_1;
    huart2.Init.Parity = UART_PARITY_NONE;
    huart2.Init.Mode = UART_MODE_TX_RX;
    huart2.Init.HwFlowCtl = UART_HWCONTROL_NONE;
    huart2.Init.OverSampling = UART_OVERSAMPLING_16;
    HAL_UART_Init(&huart2);
}

// Blocking transmit/receive
uint8_t tx_data[] = "Hello, UART!\r\n";
HAL_UART_Transmit(&huart2, tx_data, sizeof(tx_data) - 1, HAL_MAX_DELAY);

uint8_t rx_buffer[64];
HAL_UART_Receive(&huart2, rx_buffer, 10, 1000);  // 1s timeout

// Interrupt-driven (non-blocking)
volatile uint8_t rx_byte;
HAL_UART_Receive_IT(&huart2, (uint8_t*)&rx_byte, 1);

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart) {
    if (huart == &huart2) {
        process_byte(rx_byte);
        HAL_UART_Receive_IT(&huart2, (uint8_t*)&rx_byte, 1);  // Restart
    }
}
</code></pre>

                            <h2 id="spi"><i class="fas fa-sync-alt me-2 text-teal"></i>SPI Protocol</h2>

                            <p><strong>SPI (Serial Peripheral Interface)</strong> is a synchronous, full-duplex protocol with a clock line. It's the fastest common embedded protocol—used for SD cards, displays, flash memory, and ADCs.</p>

                            <div class="highlight-box">
                                <i class="fas fa-info-circle"></i>
                                <strong>SPI Signals:</strong>
                                <ul>
                                    <li><strong>SCLK:</strong> Serial Clock (generated by master)</li>
                                    <li><strong>MOSI:</strong> Master Out Slave In (data from master)</li>
                                    <li><strong>MISO:</strong> Master In Slave Out (data from slave)</li>
                                    <li><strong>CS/SS:</strong> Chip Select (one per slave, active low)</li>
                                </ul>
                            </div>

                            <div class="experiment-card">
                                <h4><i class="fas fa-cog me-2"></i>SPI Clock Modes (CPOL/CPHA)</h4>
                                <div class="card-meta mb-2">
                                    <span class="badge bg-teal">Mode 0</span>
                                    <span class="badge bg-blue">Mode 1</span>
                                    <span class="badge bg-navy">Mode 2</span>
                                    <span class="badge bg-crimson">Mode 3</span>
                                </div>
                                <div class="content">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr><th>Mode</th><th>CPOL</th><th>CPHA</th><th>Description</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>0</td><td>0</td><td>0</td><td>Clock idle low, sample on rising edge</td></tr>
                                            <tr><td>1</td><td>0</td><td>1</td><td>Clock idle low, sample on falling edge</td></tr>
                                            <tr><td>2</td><td>1</td><td>0</td><td>Clock idle high, sample on falling edge</td></tr>
                                            <tr><td>3</td><td>1</td><td>1</td><td>Clock idle high, sample on rising edge</td></tr>
                                        </tbody>
                                    </table>
                                    <p><em>Mode 0 and Mode 3 are most common. Check your device's datasheet!</em></p>
                                </div>
                            </div>

<pre><code class="language-c">// STM32 HAL SPI - Reading from a sensor (e.g., accelerometer)
SPI_HandleTypeDef hspi1;

void MX_SPI1_Init(void) {
    hspi1.Instance = SPI1;
    hspi1.Init.Mode = SPI_MODE_MASTER;
    hspi1.Init.Direction = SPI_DIRECTION_2LINES;
    hspi1.Init.DataSize = SPI_DATASIZE_8BIT;
    hspi1.Init.CLKPolarity = SPI_POLARITY_LOW;   // CPOL = 0
    hspi1.Init.CLKPhase = SPI_PHASE_1EDGE;       // CPHA = 0 (Mode 0)
    hspi1.Init.NSS = SPI_NSS_SOFT;               // Software CS control
    hspi1.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_8;  // 84MHz/8 = 10.5MHz
    hspi1.Init.FirstBit = SPI_FIRSTBIT_MSB;
    HAL_SPI_Init(&hspi1);
}

// Read register from SPI device
uint8_t spi_read_register(uint8_t reg) {
    uint8_t tx_data[2] = {reg | 0x80, 0x00};  // 0x80 = read bit
    uint8_t rx_data[2];
    
    HAL_GPIO_WritePin(CS_GPIO_Port, CS_Pin, GPIO_PIN_RESET);  // CS low
    HAL_SPI_TransmitReceive(&hspi1, tx_data, rx_data, 2, HAL_MAX_DELAY);
    HAL_GPIO_WritePin(CS_GPIO_Port, CS_Pin, GPIO_PIN_SET);    // CS high
    
    return rx_data[1];  // Second byte is data
}

// Write register
void spi_write_register(uint8_t reg, uint8_t value) {
    uint8_t tx_data[2] = {reg & 0x7F, value};  // Clear read bit
    
    HAL_GPIO_WritePin(CS_GPIO_Port, CS_Pin, GPIO_PIN_RESET);
    HAL_SPI_Transmit(&hspi1, tx_data, 2, HAL_MAX_DELAY);
    HAL_GPIO_WritePin(CS_GPIO_Port, CS_Pin, GPIO_PIN_SET);
}
</code></pre>

                            <h2 id="i2c"><i class="fas fa-project-diagram me-2 text-teal"></i>I2C Protocol</h2>

                            <p><strong>I2C (Inter-Integrated Circuit)</strong> uses just 2 wires (SDA data, SCL clock) with addressing to communicate with up to 127 devices. Ideal for low-speed sensors, EEPROMs, and RTCs.</p>

                            <div class="experiment-card">
                                <h4><i class="fas fa-signal me-2"></i>I2C Transaction Format</h4>
                                <div class="card-meta mb-2">
                                    <span class="badge bg-teal">2 Wires</span>
                                    <span class="badge bg-navy">Multi-Master</span>
                                    <span class="badge bg-crimson">7-bit Address</span>
                                </div>
                                <div class="content">
                                    <pre>
START | ADDR (7-bit) | R/W | ACK | DATA | ACK | DATA | ACK | STOP
  S   |  A6-A0       | W=0 | A   |  D7-D0| A  | D7-D0| A/N |  P
      |              | R=1 |     |       |    |      |     |
                                    </pre>
                                    <p><strong>Standard speeds:</strong> 100 kHz (Standard), 400 kHz (Fast), 1 MHz (Fast+), 3.4 MHz (High Speed)</p>
                                </div>
                            </div>

<pre><code class="language-c">// STM32 HAL I2C - Reading from a temperature sensor (e.g., LM75)
I2C_HandleTypeDef hi2c1;

void MX_I2C1_Init(void) {
    hi2c1.Instance = I2C1;
    hi2c1.Init.ClockSpeed = 400000;  // 400 kHz Fast Mode
    hi2c1.Init.DutyCycle = I2C_DUTYCYCLE_2;
    hi2c1.Init.OwnAddress1 = 0;
    hi2c1.Init.AddressingMode = I2C_ADDRESSINGMODE_7BIT;
    HAL_I2C_Init(&hi2c1);
}

#define LM75_ADDR (0x48 << 1)  // HAL uses 8-bit address (shift left)
#define TEMP_REG  0x00

float read_temperature(void) {
    uint8_t data[2];
    
    // Read 2 bytes from temperature register
    HAL_I2C_Mem_Read(&hi2c1, LM75_ADDR, TEMP_REG, I2C_MEMADD_SIZE_8BIT,
                     data, 2, HAL_MAX_DELAY);
    
    // Convert (9-bit resolution, 0.5°C per bit)
    int16_t raw = (data[0] << 8) | data[1];
    return (raw >> 7) * 0.5f;
}

// Scan I2C bus for devices
void i2c_scan(void) {
    printf("Scanning I2C bus...\n");
    for (uint8_t addr = 1; addr < 127; addr++) {
        if (HAL_I2C_IsDeviceReady(&hi2c1, addr << 1, 1, 10) == HAL_OK) {
            printf("Found device at 0x%02X\n", addr);
        }
    }
}
</code></pre>

                            <h2 id="can"><i class="fas fa-car me-2 text-teal"></i>CAN Bus Protocol</h2>

                            <p><strong>CAN (Controller Area Network)</strong> is a robust, multi-master protocol designed for automotive and industrial environments. It handles electrical noise, supports prioritization, and has built-in error detection.</p>

                            <div class="highlight-box">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>CAN Key Features:</strong>
                                <ul>
                                    <li><strong>Differential signaling:</strong> Immune to noise (CAN_H / CAN_L)</li>
                                    <li><strong>Multi-master:</strong> Any node can transmit when bus is free</li>
                                    <li><strong>Priority arbitration:</strong> Lower ID = higher priority</li>
                                    <li><strong>Error handling:</strong> CRC, ACK, bit stuffing, error frames</li>
                                    <li><strong>Speeds:</strong> 125 kbps (long range) to 1 Mbps (CAN 2.0), 5+ Mbps (CAN FD)</li>
                                </ul>
                            </div>

<pre><code class="language-c">// STM32 HAL CAN - Basic transmit/receive
CAN_HandleTypeDef hcan1;

void MX_CAN1_Init(void) {
    hcan1.Instance = CAN1;
    hcan1.Init.Prescaler = 6;           // 42MHz / 6 = 7MHz
    hcan1.Init.Mode = CAN_MODE_NORMAL;
    hcan1.Init.SyncJumpWidth = CAN_SJW_1TQ;
    hcan1.Init.TimeSeg1 = CAN_BS1_5TQ;  // 7MHz / (1+5+1) = 1 Mbps
    hcan1.Init.TimeSeg2 = CAN_BS2_1TQ;
    hcan1.Init.TimeTriggeredMode = DISABLE;
    hcan1.Init.AutoBusOff = ENABLE;
    hcan1.Init.AutoWakeUp = ENABLE;
    hcan1.Init.AutoRetransmission = ENABLE;
    hcan1.Init.ReceiveFifoLocked = DISABLE;
    hcan1.Init.TransmitFifoPriority = DISABLE;
    HAL_CAN_Init(&hcan1);
}

// Configure receive filter (accept messages with ID 0x100-0x1FF)
void can_filter_config(void) {
    CAN_FilterTypeDef filter;
    filter.FilterBank = 0;
    filter.FilterMode = CAN_FILTERMODE_IDMASK;
    filter.FilterScale = CAN_FILTERSCALE_32BIT;
    filter.FilterIdHigh = 0x100 << 5;
    filter.FilterIdLow = 0;
    filter.FilterMaskIdHigh = 0x700 << 5;  // Check bits 8-10
    filter.FilterMaskIdLow = 0;
    filter.FilterFIFOAssignment = CAN_RX_FIFO0;
    filter.FilterActivation = ENABLE;
    HAL_CAN_ConfigFilter(&hcan1, &filter);
}

// Transmit CAN message
void can_send(uint16_t id, uint8_t *data, uint8_t len) {
    CAN_TxHeaderTypeDef header;
    uint32_t mailbox;
    
    header.StdId = id;
    header.IDE = CAN_ID_STD;
    header.RTR = CAN_RTR_DATA;
    header.DLC = len;
    
    HAL_CAN_AddTxMessage(&hcan1, &header, data, &mailbox);
}

// Receive callback
void HAL_CAN_RxFifo0MsgPendingCallback(CAN_HandleTypeDef *hcan) {
    CAN_RxHeaderTypeDef header;
    uint8_t data[8];
    
    HAL_CAN_GetRxMessage(hcan, CAN_RX_FIFO0, &header, data);
    
    printf("CAN ID: 0x%03X, Data: ", (unsigned int)header.StdId);
    for (int i = 0; i < header.DLC; i++) {
        printf("%02X ", data[i]);
    }
    printf("\n");
}
</code></pre>

                            <h2 id="usb"><i class="fas fa-usb me-2 text-teal"></i>USB Protocol</h2>

                            <p><strong>USB (Universal Serial Bus)</strong> is the most complex embedded protocol but also the most versatile. STM32 devices support USB Device (peripheral), Host, and OTG modes.</p>

                            <div class="experiment-card">
                                <h4><i class="fas fa-layer-group me-2"></i>USB Device Classes</h4>
                                <div class="card-meta mb-2">
                                    <span class="badge bg-teal">CDC</span>
                                    <span class="badge bg-navy">HID</span>
                                    <span class="badge bg-crimson">MSC</span>
                                </div>
                                <div class="content">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr><th>Class</th><th>Use Case</th><th>Driver Required</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>CDC (Communications)</td><td>Virtual COM port</td><td>Built-in (most OS)</td></tr>
                                            <tr><td>HID (Human Interface)</td><td>Keyboard, mouse, custom</td><td>Built-in</td></tr>
                                            <tr><td>MSC (Mass Storage)</td><td>Flash drive, SD card reader</td><td>Built-in</td></tr>
                                            <tr><td>Audio</td><td>USB microphone, speaker</td><td>Built-in</td></tr>
                                            <tr><td>Custom/Vendor</td><td>Proprietary protocols</td><td>Custom driver</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

<pre><code class="language-c">// USB CDC (Virtual COM Port) - STM32 HAL with CubeMX-generated middleware
// Include files generated by CubeMX
#include "usbd_cdc_if.h"

// Transmit data over USB CDC
void usb_print(const char *msg) {
    CDC_Transmit_FS((uint8_t*)msg, strlen(msg));
}

// Receive callback (in usbd_cdc_if.c)
static int8_t CDC_Receive_FS(uint8_t* Buf, uint32_t *Len) {
    // Process received data
    for (uint32_t i = 0; i < *Len; i++) {
        process_byte(Buf[i]);
    }
    
    // Prepare for next reception
    USBD_CDC_SetRxBuffer(&hUsbDeviceFS, &Buf[0]);
    USBD_CDC_ReceivePacket(&hUsbDeviceFS);
    
    return USBD_OK;
}
</code></pre>

                            <h2 id="comparison"><i class="fas fa-balance-scale me-2 text-teal"></i>Protocol Comparison</h2>

                            <div class="experiment-card">
                                <h4><i class="fas fa-table me-2"></i>When to Use Which Protocol</h4>
                                <div class="card-meta mb-2">
                                    <span class="badge bg-teal">Decision Matrix</span>
                                </div>
                                <div class="content">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr><th>Protocol</th><th>Speed</th><th>Wires</th><th>Devices</th><th>Best For</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>UART</td><td>~1 Mbps</td><td>2</td><td>Point-to-point</td><td>Debug, GPS, BT modules</td></tr>
                                            <tr><td>SPI</td><td>~50 Mbps</td><td>4+</td><td>1+ (CS per device)</td><td>Fast sensors, displays, flash</td></tr>
                                            <tr><td>I2C</td><td>~3.4 Mbps</td><td>2</td><td>127</td><td>Low-speed sensors, EEPROM</td></tr>
                                            <tr><td>CAN</td><td>~1 Mbps</td><td>2 (diff)</td><td>100+</td><td>Automotive, industrial</td></tr>
                                            <tr><td>USB</td><td>~480 Mbps</td><td>4</td><td>127</td><td>PC connectivity, power</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <h2 id="debugging"><i class="fas fa-bug me-2 text-teal"></i>Protocol Debugging Tools</h2>

                            <div class="highlight-box">
                                <i class="fas fa-tools"></i>
                                <strong>Essential Debug Tools:</strong>
                                <ul>
                                    <li><strong>Logic Analyzer:</strong> Saleae Logic, PulseView - decode all protocols</li>
                                    <li><strong>Oscilloscope:</strong> Signal integrity, timing, noise analysis</li>
                                    <li><strong>USB Protocol Analyzer:</strong> Total Phase Beagle, Wireshark (software)</li>
                                    <li><strong>CAN Analyzer:</strong> PCAN-USB, Vector CANalyzer</li>
                                    <li><strong>Serial Terminals:</strong> PuTTY, CoolTerm, minicom</li>
                                </ul>
                            </div>

                            <h2 id="conclusion"><i class="fas fa-flag-checkered me-2 text-teal"></i>Conclusion & What's Next</h2>

                            <p>You've mastered the essential embedded communication protocols—UART for debugging, SPI for speed, I2C for simplicity, CAN for robustness, and USB for PC connectivity. Protocol selection is a key design decision that impacts cost, complexity, and performance.</p>

                            <div class="highlight-box" style="background: rgba(191, 9, 47, 0.1); border-left-color: var(--color-crimson);">
                                <i class="fas fa-rocket"></i>
                                <strong>Key Takeaways:</strong>
                                <ul>
                                    <li>UART: Simplest, point-to-point, no clock (use for debug)</li>
                                    <li>SPI: Fastest, full duplex, separate CS per slave</li>
                                    <li>I2C: 2-wire multi-device, 7-bit addressing</li>
                                    <li>CAN: Automotive-grade, differential, priority arbitration</li>
                                    <li>USB: Complex but powerful, many device classes</li>
                                </ul>
                            </div>

                            <p>In <strong>Part 5</strong>, we transition from bare-metal to <strong>Embedded Linux</strong>—learning the kernel, userspace, and filesystem architecture for more powerful embedded systems.</p>

                            <div id="next-steps" class="blog-content mt-5">
                                <h2><i class="fas fa-arrow-right me-2 text-teal"></i>Next Steps</h2>
                                
                                <div class="related-posts">
                                    <h3><i class="fas fa-book-reader me-2"></i>Continue the Series</h3>
                                    <div class="related-post-item">
                                        <h5 class="mb-2">Part 3: RTOS Fundamentals (FreeRTOS/Zephyr)</h5>
                                        <p class="text-muted small mb-2">Review task management and real-time scheduling.</p>
                                        <a href="embedded-systems-rtos.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                                    </div>
                                    <div class="related-post-item">
                                        <h5 class="mb-2">Part 5: Embedded Linux Fundamentals</h5>
                                        <p class="text-muted small mb-2">Transition from bare-metal to Linux-based embedded systems.</p>
                                        <a href="embedded-systems-linux-fundamentals.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                                    </div>
                                    <div class="related-post-item">
                                        <h5 class="mb-2">Part 6: U-Boot Bootloader Mastery</h5>
                                        <p class="text-muted small mb-2">Learn bootloader configuration and customization.</p>
                                        <a href="embedded-systems-uboot.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="social-media" class="bg-dark text-light py-5">
        <div class="container py-5">
            <div class="row mb-4">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <h5 class="fw-bold mb-3">Let's Connect</h5>
                    <p class="text-light">I'm always interested in sharing content about my interests on different topics. Read disclaimer and feel free to share further.</p>
                </div>
                <div class="col-lg-6">
                    <h5 class="fw-bold mb-3">Follow Me</h5>
                    <div class="social-links d-flex gap-2 flex-wrap">
                        <a href="https://www.facebook.com/wasil.zafar/" target="_blank" class="social-icon" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com/wasilzafar" target="_blank" class="social-icon" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.linkedin.com/in/wasilzafar" target="_blank" class="social-icon" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@wasilzafar" target="_blank" class="social-icon" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://www.instagram.com/itswzee/" target="_blank" class="social-icon" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://in.pinterest.com/wasilz/" target="_blank" class="social-icon" title="Pinterest"><i class="fab fa-pinterest-p"></i></a>
                        <a href="mailto:wasil.zafar@gmail.com" class="social-icon" title="Email"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
            </div>
            <hr class="bg-secondary">
            <div class="row mt-4">
                <div class="col-md-6">
                    <p class="small"><i class="fas fa-icons me-2"></i>Icons from <a href="https://www.flaticon.com/" target="_blank" class="text-light">Flaticon</a> &amp; <a href="https://fontawesome.com/" target="_blank" class="text-light">Font Awesome</a></p>
                    <p class="small mt-3"><a href="/" class="text-light text-decoration-none">Home</a> | <a href="/disclaimer.html" class="text-light text-decoration-none">Disclaimer</a> | <a href="/privacy-policy.html" class="text-light text-decoration-none">Privacy Policy</a></p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small">Enjoying this content? ☕ <a href="https://buymeacoffee.com/itswzee" target="_blank" class="text-light" style="text-decoration: underline;">Keep me caffeinated</a> to keep the pixels flowing!</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <button id="scrollToTop" class="scroll-to-top" title="Back to Top"><i class="fas fa-arrow-up"></i></button>
    <!-- Category Indicator -->
    <div id="categoryIndicator" class="category-indicator" title="Current Section">
        <i class="fas fa-tag"></i><span id="categoryText">Technology</span>
    </div>
    <script src="../../../js/cookie-consent.js"></script>
    <script src="../../../js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            window.addEventListener('scroll', function() { if (window.scrollY > 300) { scrollToTopBtn.classList.add('show'); } else { scrollToTopBtn.classList.remove('show'); } });
            scrollToTopBtn.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });
        });
    </script>

    <script>
        function openNav() { document.getElementById('tocSidenav').classList.add('open'); document.getElementById('tocOverlay').classList.add('show'); document.body.style.overflow = 'hidden'; }
        function closeNav() { document.getElementById('tocSidenav').classList.remove('open'); document.getElementById('tocOverlay').classList.remove('show'); document.body.style.overflow = 'auto'; }
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeNav(); } });
        document.addEventListener('DOMContentLoaded', function() {
            const sections = document.querySelectorAll('[id]');
            const tocLinks = document.querySelectorAll('.sidenav-toc a');
            function highlightActiveSection() { let currentSection = ''; sections.forEach(section => { if (window.scrollY >= section.offsetTop - 200) { currentSection = section.getAttribute('id'); } }); tocLinks.forEach(link => { link.classList.remove('active'); if (link.getAttribute('href') === '#' + currentSection) { link.classList.add('active'); } }); }
            window.addEventListener('scroll', highlightActiveSection);
            highlightActiveSection();
            tocLinks.forEach(link => { link.addEventListener('click', function(e) { e.preventDefault(); const targetSection = document.querySelector(this.getAttribute('href')); if (targetSection) { window.scrollTo({ top: targetSection.offsetTop - 80, behavior: 'smooth' }); } setTimeout(closeNav, 300); }); });
        });
    </script>

    <script>
        const themes = { 'prism-theme': 'Tomorrow Night', 'prism-default': 'Default', 'prism-dark': 'Dark', 'prism-twilight': 'Twilight', 'prism-okaidia': 'Okaidia', 'prism-solarizedlight': 'Solarized Light' };
        const savedTheme = localStorage.getItem('prism-theme') || 'prism-theme';
        function switchTheme(themeId) { Object.keys(themes).forEach(id => { const link = document.getElementById(id); if (link) { link.disabled = true; } }); const selectedLink = document.getElementById(themeId); if (selectedLink) { selectedLink.disabled = false; localStorage.setItem('prism-theme', themeId); } document.querySelectorAll('div.code-toolbar select').forEach(dropdown => { dropdown.value = themeId; }); setTimeout(() => { Prism.highlightAll(); }, 10); }
        document.addEventListener('DOMContentLoaded', function() { switchTheme(savedTheme); });
        Prism.plugins.toolbar.registerButton('theme-switcher', function(env) { const select = document.createElement('select'); select.className = 'prism-theme-selector'; Object.keys(themes).forEach(themeId => { const option = document.createElement('option'); option.value = themeId; option.textContent = themes[themeId]; if (themeId === savedTheme) { option.selected = true; } select.appendChild(option); }); select.addEventListener('change', function(e) { switchTheme(e.target.value); }); return select; });
    </script>

            </body>
</html>