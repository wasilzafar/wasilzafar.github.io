<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="robots" content="index, archive" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Master x86 bootloader development: MBR boot sector structure, BIOS interrupts, real mode programming, loading kernels, and transitioning from 16-bit real mode to protected mode." />
    <meta name="author" content="Wasil Zafar" />
    <meta name="keywords" content="Bootloader, Boot Sector, MBR, BIOS, Real Mode, Protected Mode Transition, Kernel Loading, OS Development, x86 Boot" />
    <meta property="og:title" content="x86 Assembly Series Part 19: Bootloader Development" />
    <meta property="og:description" content="Write bootloaders and boot sector code for OS development." />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2026-02-06" />
    <meta property="article:author" content="Wasil Zafar" />
    <meta property="article:section" content="Technology" />
    
    <title>x86 Assembly Series Part 19: Bootloader Development - Wasil Zafar</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" id="prism-theme" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="../../../images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../images/favicon_io/favicon-32x32.png">
    <link rel="manifest" href="../../../images/favicon_io/site.webmanifest">

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', { 'ad_storage': 'denied', 'ad_user_data': 'denied', 'ad_personalization': 'denied', 'analytics_storage': 'denied', 'region': ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE'] });
        gtag('consent', 'default', { 'ad_storage': 'granted', 'ad_user_data': 'granted', 'ad_personalization': 'granted', 'analytics_storage': 'granted' });
    </script>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PBS8M2JR');</script>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PBS8M2JR" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/"><span class="gradient-text">Wasil Zafar</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#skills">Skills</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#certifications">Certifications</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#interests">Interests</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="blog-hero">
        <div class="container py-5">
            <div class="blog-header">
                <a href="/pages/categories/technology.html" class="back-link"><i class="fas fa-arrow-left me-2"></i>Back to Technology</a>
                <h1 class="display-4 fw-bold mb-3">x86 Assembly Series Part 19: Bootloader Development</h1>
                <div class="blog-meta">
                    <span><i class="fas fa-calendar me-2"></i>February 6, 2026</span>
                    <span><i class="fas fa-user me-2"></i>Wasil Zafar</span>
                    <span class="reading-time"><i class="fas fa-clock me-1"></i>40 min read</span>
                    <button onclick="window.print()" class="print-btn"><i class="fas fa-print"></i> Print</button>
                </div>
                <p class="lead">Master bootloader development: BIOS boot process, MBR structure, real mode assembly, disk I/O with BIOS interrupts, loading a kernel, and transitioning to protected/long mode.</p>
            </div>
        </div>
    </section>

    <button class="toc-toggle-btn" onclick="openNav()" title="Table of Contents"><i class="fas fa-list"></i></button>

    <div id="tocSidenav" class="sidenav-toc">
        <div class="toc-header">
            <h3><i class="fas fa-list me-2"></i>Table of Contents</h3>
            <button class="closebtn" onclick="closeNav()">&times;</button>
        </div>
        <ol>
            <li><a href="#boot-process" onclick="closeNav()">BIOS Boot Process</a></li>
            <li><a href="#mbr" onclick="closeNav()">MBR Structure</a></li>
            <li><a href="#hello-boot" onclick="closeNav()">Hello World Bootloader</a></li>
            <li><a href="#bios-int" onclick="closeNav()">BIOS Interrupts</a>
                <ul>
                    <li><a href="#int10" onclick="closeNav()">INT 10h (Video)</a></li>
                    <li><a href="#int13" onclick="closeNav()">INT 13h (Disk)</a></li>
                </ul>
            </li>
            <li><a href="#load-kernel" onclick="closeNav()">Loading the Kernel</a></li>
            <li><a href="#transition" onclick="closeNav()">Mode Transition</a></li>
            <li><a href="#test-qemu" onclick="closeNav()">Testing with QEMU</a></li>
        </ol>
    </div>
    <div id="tocOverlay" class="sidenav-overlay" onclick="closeNav()"></div>

    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">

                <div id="boot-process" class="blog-content">
                    <h2><i class="fas fa-power-off me-2 text-teal"></i>BIOS Boot Process</h2>
                    
                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Boot Sequence:</strong> 1) Power on → 2) BIOS POST → 3) Load MBR (sector 0) to 0x7C00 → 4) Jump to 0x7C00 → 5) Your code runs in 16-bit real mode!
                    </div>

                    <div class="experiment-card">
                        <h4><i class="fas fa-map-signs me-2"></i>Complete Series Navigation</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-teal me-2">25-Part Series</span>
                            <span class="badge bg-crimson">x86 Assembly Mastery</span>
                        </div>
                        <div class="content">
                            <p><strong>Foundation & Environment Setup</strong></p>
                            <ol start="0">
                                <li><a href="asm-part00-environment-setup.html">Development Environment, Tooling & Workflow</a></li>
                                <li><a href="asm-part01-fundamentals.html">Assembly Language Fundamentals & Toolchain Setup</a></li>
                                <li><a href="asm-part02-cpu-architecture.html">x86 CPU Architecture Overview</a></li>
                                <li><a href="asm-part03-registers.html">Registers – Complete Deep Dive</a></li>
                                <li><a href="asm-part04-instruction-encoding.html">Instruction Encoding & Binary Layout</a></li>
                            </ol>
                            <p class="mt-3"><strong>Assemblers, Syntax & Memory</strong></p>
                            <ol start="5">
                                <li><a href="asm-part05-nasm.html">NASM Syntax, Directives & Macros</a></li>
                                <li><a href="asm-part06-masm.html">Complete Assembler Comparison</a></li>
                                <li><a href="asm-part07-memory-addressing.html">Memory Addressing Modes</a></li>
                            </ol>
                            <p class="mt-3"><strong>Control Flow, Stack & Computation</strong></p>
                            <ol start="8">
                                <li><a href="asm-part08-stack-calling.html">Stack Internals & Calling Conventions</a></li>
                                <li><a href="asm-part09-control-flow.html">Control Flow & Procedures</a></li>
                                <li><a href="asm-part10-arithmetic.html">Integer, Bitwise & Arithmetic Operations</a></li>
                            </ol>
                            <p class="mt-3"><strong>Floating Point, SIMD & Performance</strong></p>
                            <ol start="11">
                                <li><a href="asm-part11-floating-point.html">Floating Point & SIMD Foundations</a></li>
                                <li><a href="asm-part12-simd.html">SIMD, Vectorization & Performance</a></li>
                            </ol>
                            <p class="mt-3"><strong>OS Interaction & Debugging</strong></p>
                            <ol start="13">
                                <li><a href="asm-part13-syscalls-interrupts.html">System Calls, Interrupts & Privilege Transitions</a></li>
                                <li><a href="asm-part14-debugging.html">Debugging & Reverse Engineering</a></li>
                                <li><a href="asm-part15-linking.html">Linking, Relocation & Loader Behavior</a></li>
                            </ol>
                            <p class="mt-3"><strong>Advanced Architecture & Interoperability</strong></p>
                            <ol start="16">
                                <li><a href="asm-part16-long-mode.html">x86-64 Long Mode & Advanced Features</a></li>
                                <li><a href="asm-part17-c-interop.html">Assembly + C/C++ Interoperability</a></li>
                                <li><a href="asm-part18-security.html">Memory Protection & Security Concepts</a></li>
                            </ol>
                            <p class="mt-3"><strong>Bare Metal, Kernel & Virtualization</strong></p>
                            <ol start="19">
                                <li><strong>Bootloaders & Bare-Metal Programming (This Guide)</strong></li>
                                <li><a href="asm-part20-kernel.html">Kernel-Level Assembly</a></li>
                                <li><a href="asm-part21-qemu.html">Complete Emulator & Simulator Guide</a></li>
                            </ol>
                            <p class="mt-3"><strong>CPU Microarchitecture & Optimization</strong></p>
                            <ol start="22">
                                <li><a href="asm-part22-optimization.html">Advanced Optimization & CPU Internals</a></li>
                            </ol>
                            <p class="mt-3"><strong>Real-World Application & Mastery</strong></p>
                            <ol start="23">
                                <li><a href="asm-part23-projects.html">Real-World Assembly Projects</a></li>
                                <li><a href="asm-part24-capstone.html">Assembly Mastery Capstone</a></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div id="mbr" class="blog-content mt-5">
                    <h2><i class="fas fa-hdd me-2 text-teal"></i>MBR Structure</h2>
                    
                    <div class="experiment-card">
                        <div class="card-meta mb-2"><span class="badge bg-teal text-white">Reference</span></div>
                        <h4>Master Boot Record Layout (512 bytes)</h4>
                        <pre><code class="language-bash">Offset   Size    Description
0x000    446     Bootloader code
0x1BE    64      Partition table (4 × 16 bytes)
0x1FE    2       Boot signature (0x55, 0xAA)</code></pre>
                    </div>
                </div>

                <div id="hello-boot" class="blog-content mt-5">
                    <h2><i class="fas fa-play me-2 text-teal"></i>Hello World Bootloader</h2>
                    
                    <pre><code class="language-nasm">[BITS 16]                   ; 16-bit real mode
[ORG 0x7C00]                ; BIOS loads us here

start:
    ; Set up segment registers
    xor ax, ax
    mov ds, ax
    mov es, ax
    mov ss, ax
    mov sp, 0x7C00          ; Stack below bootloader

    ; Print "Hello"
    mov si, message
    call print_string

    ; Halt
    cli                     ; Disable interrupts
    hlt                     ; Halt CPU

print_string:
    mov ah, 0x0E            ; BIOS teletype function
.loop:
    lodsb                   ; Load byte from SI into AL
    test al, al             ; Check for null terminator
    jz .done
    int 0x10                ; BIOS video interrupt
    jmp .loop
.done:
    ret

message: db "Hello from bootloader!", 0

; Pad to 510 bytes and add boot signature
times 510 - ($ - $$) db 0
dw 0xAA55                   ; Boot signature</code></pre>

                    <pre><code class="language-bash"># Assemble and test
nasm -f bin boot.asm -o boot.bin
qemu-system-x86_64 -drive format=raw,file=boot.bin</code></pre>
                </div>

                <div id="bios-int" class="blog-content mt-5">
                    <h2><i class="fas fa-microchip me-2 text-teal"></i>BIOS Interrupts</h2>
                    
                    <h3 id="int10">INT 10h (Video Services)</h3>
                    
                    <p>INT 10h provides BIOS video services—your interface to the screen before any OS is loaded.</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-dark">
                                <tr><th>AH</th><th>Function</th><th>Parameters</th><th>Returns</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>0x00</td><td>Set Video Mode</td><td>AL = mode (0x03=text, 0x13=VGA)</td><td>-</td></tr>
                                <tr><td>0x02</td><td>Set Cursor Position</td><td>BH=page, DH=row, DL=col</td><td>-</td></tr>
                                <tr><td>0x03</td><td>Get Cursor Position</td><td>BH=page</td><td>DH=row, DL=col</td></tr>
                                <tr><td>0x0E</td><td>Teletype Output</td><td>AL=char, BL=color</td><td>-</td></tr>
                                <tr><td>0x13</td><td>Write String</td><td>ES:BP=string, CX=len, DH/DL=pos</td><td>-</td></tr>
                            </tbody>
                        </table>
                    </div>

<pre><code class="language-nasm">; Video services examples
bits 16
org 0x7C00

; Set 80x25 text mode
mov ah, 0x00
mov al, 0x03            ; 80x25 color text
int 0x10

; Set cursor to row 5, column 10
mov ah, 0x02
mov bh, 0               ; Page 0
mov dh, 5               ; Row
mov dl, 10              ; Column
int 0x10

; Print character 'A' in light green
mov ah, 0x0E
mov al, 'A'
mov bl, 0x0A            ; Light green
int 0x10

; Print string using INT 10h function 13h
mov ah, 0x13
mov al, 1               ; Mode: update cursor
mov bh, 0               ; Page 0
mov bl, 0x0F            ; White on black
mov cx, msg_len         ; String length
mov dh, 10              ; Row 10
mov dl, 20              ; Column 20
mov bp, message         ; ES:BP = string
int 0x10

message: db "Boot OK!"
msg_len equ $ - message</code></pre>

                    <h3 id="int13">INT 13h (Disk Services)</h3>
                    
                    <p>INT 13h is the BIOS disk interface. Use it to load your kernel from disk into memory.</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-dark">
                                <tr><th>AH</th><th>Function</th><th>Key Parameters</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>0x00</td><td>Reset Disk</td><td>DL = drive (0=floppy, 0x80=HDD)</td></tr>
                                <tr><td>0x02</td><td>Read Sectors</td><td>AL=count, CH=cyl, CL=sector, DH=head, DL=drive, ES:BX=buffer</td></tr>
                                <tr><td>0x03</td><td>Write Sectors</td><td>Same as 0x02</td></tr>
                                <tr><td>0x08</td><td>Get Drive Parameters</td><td>DL=drive; Returns geometry</td></tr>
                                <tr><td>0x42</td><td>Extended Read (LBA)</td><td>DS:SI = DAP (Disk Address Packet)</td></tr>
                            </tbody>
                        </table>
                    </div>

<pre><code class="language-nasm">; Read sectors using CHS (Cylinder-Head-Sector)
read_sectors_chs:
    ; Parameters: Read 2 sectors starting from sector 2
    mov ah, 0x02        ; Read sectors function
    mov al, 2           ; Number of sectors
    mov ch, 0           ; Cylinder 0
    mov cl, 2           ; Starting sector (1-based!)
    mov dh, 0           ; Head 0
    mov dl, 0x80        ; Drive 0x80 = first hard disk
    mov bx, 0x1000      ; ES:BX = buffer (0x0000:0x1000)
    int 0x13
    jc .disk_error      ; Carry flag set on error
    cmp al, 2           ; Verify sectors read
    jne .disk_error
    ret
.disk_error:
    ; Handle read failure
    mov si, disk_err_msg
    call print_string
    hlt

; Modern method: LBA Read (supports drives > 8GB)
read_sectors_lba:
    mov ah, 0x42        ; Extended read
    mov dl, 0x80        ; Drive
    mov si, dap         ; DS:SI = Disk Address Packet
    int 0x13
    jc .disk_error
    ret

align 4
dap:                    ; Disk Address Packet (DAP)
    db 16               ; Size of DAP (16 bytes)
    db 0                ; Reserved
    dw 4                ; Number of sectors to read
    dw 0x1000           ; Offset (buffer)
    dw 0x0000           ; Segment (buffer)
    dq 1                ; Starting LBA (sector 1 = second sector)</code></pre>

                    <div class="highlight-box">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>CHS vs LBA:</strong> CHS addressing has geometry limits (~8GB). Use LBA (INT 13h AH=42h) for modern compatibility. Check for LBA support with INT 13h AH=41h.
                    </div>
                </div>

                <div id="load-kernel" class="blog-content mt-5">
                    <h2><i class="fas fa-download me-2 text-teal"></i>Loading the Kernel</h2>
                    
                    <p>A real bootloader loads the kernel from disk into memory, then jumps to it. Here's a two-stage approach:</p>
                    
<pre><code class="language-plaintext">Memory Map During Boot:

  0x00000 - 0x003FF  Interrupt Vector Table (IVT)
  0x00400 - 0x004FF  BIOS Data Area
  0x00500 - 0x07BFF  Free (usable for stack)
  0x07C00 - 0x07DFF  Boot Sector (512 bytes) ← Stage 1
  0x07E00 - 0x7FFFF  Free (usable for Stage 2 + kernel)
  0x80000 - 0x9FFFF  Extended BIOS Data Area
  0xA0000 - 0xBFFFF  Video Memory
  0xC0000 - 0xFFFFF  BIOS ROM</code></pre>

                    <h3>Stage 1: Boot Sector (512 bytes max)</h3>
<pre><code class="language-nasm">; stage1.asm - Boot sector that loads stage 2
bits 16
org 0x7C00

STAGE2_ADDR equ 0x7E00      ; Load stage 2 right after boot sector
STAGE2_SECTORS equ 16       ; 16 sectors = 8KB stage 2

_start:
    ; Setup segments
    xor ax, ax
    mov ds, ax
    mov es, ax
    mov ss, ax
    mov sp, 0x7C00
    
    ; Save boot drive
    mov [boot_drive], dl
    
    ; Print loading message
    mov si, loading_msg
    call print_string
    
    ; Load stage 2 from disk
    mov ah, 0x02            ; Read sectors
    mov al, STAGE2_SECTORS  ; Sector count
    mov ch, 0               ; Cylinder 0
    mov cl, 2               ; Start at sector 2 (sector 1 = boot sector)
    mov dh, 0               ; Head 0
    mov dl, [boot_drive]
    mov bx, STAGE2_ADDR     ; ES:BX = destination
    int 0x13
    jc disk_error
    
    ; Jump to stage 2
    jmp STAGE2_ADDR

disk_error:
    mov si, error_msg
    call print_string
    hlt

print_string:
    lodsb
    test al, al
    jz .done
    mov ah, 0x0E
    int 0x10
    jmp print_string
.done:
    ret

boot_drive: db 0
loading_msg: db "Loading stage 2...", 13, 10, 0
error_msg: db "Disk error!", 0

times 510 - ($ - $$) db 0
dw 0xAA55</code></pre>

                    <div class="highlight-box mt-3">
                        <h5><i class="fas fa-terminal me-2"></i>Save &amp; Compile: <code>stage1.asm</code></h5>
                        <p><span class="badge bg-secondary"><i class="fas fa-globe me-1"></i>All Platforms</span> <small class="text-muted">(flat binary — no OS-specific linking)</small></p>
<pre><code class="language-bash">nasm -f bin stage1.asm -o stage1.bin
qemu-system-x86_64 -drive format=raw,file=stage1.bin</code></pre>
                    </div>

                    <h3>Stage 2: Larger Loader</h3>
<pre><code class="language-nasm">; stage2.asm - More room for kernel loading, A20, etc.
bits 16
org 0x7E00

KERNEL_ADDR equ 0x10000     ; Load kernel at 64KB mark

stage2_start:
    mov si, stage2_msg
    call print_string
    
    ; Enable A20 line (access memory > 1MB)
    call enable_a20
    
    ; Load kernel (example: 64 sectors = 32KB)
    mov ah, 0x02
    mov al, 64
    mov ch, 0
    mov cl, 18              ; After stage 2 sectors
    mov dh, 0
    mov dl, 0x80
    mov bx, KERNEL_ADDR
    int 0x13
    
    ; Setup GDT and enter protected mode...
    ; (See Mode Transition section)
    
    jmp $

enable_a20:
    ; Fast A20 via port 0x92
    in al, 0x92
    or al, 2
    out 0x92, al
    ret

stage2_msg: db "Stage 2 loaded!", 13, 10, 0</code></pre>

                    <div class="highlight-box mt-3">
                        <h5><i class="fas fa-terminal me-2"></i>Save &amp; Compile: <code>stage2.asm</code></h5>
                        <p><span class="badge bg-secondary"><i class="fas fa-globe me-1"></i>All Platforms</span> <small class="text-muted">(flat binary — combine with stage1 to run)</small></p>
<pre><code class="language-bash">nasm -f bin stage2.asm -o stage2.bin
cat stage1.bin stage2.bin > os.img
qemu-system-x86_64 -drive format=raw,file=os.img</code></pre>
                    </div>
                </div>

                <div id="transition" class="blog-content mt-5">
                    <h2><i class="fas fa-exchange-alt me-2 text-teal"></i>Mode Transition</h2>
                    
                    <p>Transitioning from real mode to protected/long mode is the bootloader's most critical task. Here's the complete sequence:</p>
                    
<pre><code class="language-plaintext">Mode Transition Checklist:

☐ 1. Disable interrupts (CLI)
☐ 2. Enable A20 gate (access > 1MB)
☐ 3. Load Global Descriptor Table (LGDT)
☐ 4. Set CR0.PE = 1 (Protected Mode Enable)
☐ 5. Far jump to flush prefetch queue
☐ 6. Reload segment registers with GDT selectors

For 64-bit Long Mode, also:
☐ 7. Enable PAE (CR4.PAE = 1)
☐ 8. Setup 4-level page tables
☐ 9. Load CR3 with PML4 address
☐ 10. Enable Long Mode (EFER.LME = 1)
☐ 11. Enable Paging (CR0.PG = 1)
☐ 12. Far jump to 64-bit code segment</code></pre>

<pre><code class="language-nasm">; Complete Real → Protected Mode transition
bits 16

enter_protected_mode:
    cli                     ; 1. Disable interrupts
    
    ; 2. Enable A20 (keyboard controller method)
    call .wait_ready
    mov al, 0xAD            ; Disable keyboard
    out 0x64, al
    call .wait_ready
    mov al, 0xD0            ; Read output port
    out 0x64, al
    call .wait_data
    in al, 0x60             ; Get current value
    push ax
    call .wait_ready
    mov al, 0xD1            ; Write output port
    out 0x64, al
    call .wait_ready
    pop ax
    or al, 2                ; Set A20 bit
    out 0x60, al
    call .wait_ready
    mov al, 0xAE            ; Enable keyboard
    out 0x64, al
    jmp .a20_done
    
.wait_ready:
    in al, 0x64
    test al, 2
    jnz .wait_ready
    ret
.wait_data:
    in al, 0x64
    test al, 1
    jz .wait_data
    ret
.a20_done:

    ; 3. Load GDT
    lgdt [gdt_descriptor]
    
    ; 4. Enable Protected Mode
    mov eax, cr0
    or eax, 1
    mov cr0, eax
    
    ; 5. Far jump (flushes pipeline, loads CS)
    jmp 0x08:protected_entry

bits 32
protected_entry:
    ; 6. Reload segment registers
    mov ax, 0x10            ; Data segment selector
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax
    mov esp, 0x90000        ; Stack in free memory
    
    ; Now in 32-bit Protected Mode!
    ; Continue to long mode setup or jump to kernel...
    jmp pm_kernel_entry

; GDT for Protected Mode
align 8
gdt_start:
    dq 0                    ; Null descriptor
gdt_code:
    dw 0xFFFF, 0x0000       ; Limit, Base 0:15
    db 0x00                 ; Base 16:23
    db 10011010b            ; Access: Code, readable
    db 11001111b            ; Flags + Limit 16:19
    db 0x00                 ; Base 24:31
gdt_data:
    dw 0xFFFF, 0x0000
    db 0x00
    db 10010010b            ; Access: Data, writable
    db 11001111b
    db 0x00
gdt_end:

gdt_descriptor:
    dw gdt_end - gdt_start - 1  ; Size - 1
    dd gdt_start                ; Address</code></pre>

                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Critical:</strong> The far jump after setting CR0.PE is mandatory! It flushes the CPU's instruction prefetch queue, which may contain real-mode decoded instructions.
                    </div>
                </div>

                <div id="test-qemu" class="blog-content mt-5">
                    <h2><i class="fas fa-desktop me-2 text-teal"></i>Testing with QEMU</h2>
                    
                    <p>QEMU is essential for bootloader development. It provides fast iteration and powerful debugging capabilities.</p>
                    
                    <h3>Basic Usage</h3>
<pre><code class="language-bash"># Build and run bootloader
nasm -f bin bootloader.asm -o boot.bin

# Run in QEMU (legacy BIOS)
qemu-system-x86_64 -drive format=raw,file=boot.bin

# Create proper disk image with kernel
cat boot.bin kernel.bin > os.img
# Pad to floppy size (optional)
truncate -s 1440k os.img
qemu-system-x86_64 -fda os.img

# Hard disk emulation
qemu-system-x86_64 -hda os.img</code></pre>

                    <h3>Debugging with GDB</h3>
<pre><code class="language-bash"># Start QEMU paused, waiting for GDB connection
qemu-system-x86_64 -drive format=raw,file=boot.bin -s -S

# In another terminal, connect GDB
gdb -ex "target remote :1234" \
    -ex "set architecture i8086" \
    -ex "break *0x7c00" \
    -ex "continue"

# Useful GDB commands for bootloader debugging:
(gdb) x/10i $pc           # Disassemble at current position
(gdb) info registers      # Show all registers
(gdb) x/16xb 0x7c00       # Examine memory (hex bytes)
(gdb) stepi               # Step one instruction
(gdb) nexti               # Step over (skip calls)
(gdb) break *0x7c20       # Breakpoint at address</code></pre>

                    <h3>QEMU Options Reference</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-dark">
                                <tr><th>Option</th><th>Description</th></tr>
                            </thead>
                            <tbody>
                                <tr><td><code>-s</code></td><td>Start GDB server on port 1234</td></tr>
                                <tr><td><code>-S</code></td><td>Pause CPU at startup (wait for GDB)</td></tr>
                                <tr><td><code>-d int</code></td><td>Log interrupts to console</td></tr>
                                <tr><td><code>-d cpu,exec</code></td><td>Log CPU state and executed blocks</td></tr>
                                <tr><td><code>-D qemu.log</code></td><td>Write debug output to file</td></tr>
                                <tr><td><code>-nographic</code></td><td>Disable graphical output, use serial</td></tr>
                                <tr><td><code>-serial mon:stdio</code></td><td>Redirect serial to terminal</td></tr>
                                <tr><td><code>-m 512M</code></td><td>Set RAM size to 512MB</td></tr>
                                <tr><td><code>-monitor stdio</code></td><td>QEMU monitor in terminal</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>QEMU Monitor Commands</h3>
<pre><code class="language-bash"># Press Ctrl+Alt+2 in QEMU window for monitor, or use -monitor stdio
(qemu) info registers     # Show CPU registers
(qemu) info mem           # Show memory mappings
(qemu) xp /10i 0x7c00     # Disassemble memory
(qemu) x /16xb 0x7c00     # Examine memory
(qemu) gdbserver          # Enable GDB server
(qemu) stop               # Pause emulation
(qemu) cont               # Continue emulation
(qemu) q                  # Quit QEMU</code></pre>

                    <div class="experiment-card">
                        <div class="experiment-meta">
                            <span class="badge bg-primary">Exercise</span>
                        </div>
                        <div class="experiment-content">
                            <h4>Debug Your Bootloader</h4>
                            <ol>
                                <li>Create a bootloader that prints "Hello" and loops</li>
                                <li>Start QEMU with <code>-s -S</code></li>
                                <li>Connect GDB, set breakpoint at 0x7C00</li>
                                <li>Step through each instruction</li>
                                <li>Examine the boot signature at 0x7DFE (<code>x/2xb 0x7dfe</code>)</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="blog-content mt-5">
                    <div class="related-posts">
                        <h3><i class="fas fa-book-reader me-2"></i>Continue the Series</h3>
                        <div class="related-post-item">
                            <h5 class="mb-2">Part 18: Memory Protection & Security</h5>
                            <p class="text-muted small mb-2">Understand security mechanisms in x86.</p>
                            <a href="asm-part18-security.html" class="text-decoration-none">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                        </div>
                        <div class="related-post-item">
                            <h5 class="mb-2">Part 20: Kernel Assembly Components</h5>
                            <p class="text-muted small mb-2">Write kernel-level assembly code.</p>
                            <a href="asm-part20-kernel.html" class="text-decoration-none">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                        </div>
                        <div class="related-post-item">
                            <h5 class="mb-2">Part 21: Complete Emulator & Simulator Guide</h5>
                            <p class="text-muted small mb-2">Master QEMU, Bochs, gem5, Unicorn, and more for OS testing.</p>
                            <a href="asm-part21-qemu.html" class="text-decoration-none">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                        </div>
                    </div>
                </div>

                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="social-media" class="bg-dark text-light py-5">
        <div class="container py-5">
            <div class="row mb-4">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <h5 class="fw-bold mb-3">Let's Connect</h5>
                    <p class="text-light">
                        I'm always interested in sharing content about my interests on different topics. Read disclaimer and feel free to share further.
                    </p>
                </div>
                <div class="col-lg-6">
                    <h5 class="fw-bold mb-3">Follow Me</h5>
                    <div class="social-links d-flex gap-2 flex-wrap">
                        <a href="https://www.facebook.com/wasil.zafar/" target="_blank" class="social-icon" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com/wasilzafar" target="_blank" class="social-icon" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.linkedin.com/in/wasilzafar" target="_blank" class="social-icon" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@wasilzafar" target="_blank" class="social-icon" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://www.instagram.com/itswzee/" target="_blank" class="social-icon" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://in.pinterest.com/wasilz/" target="_blank" class="social-icon" title="Pinterest"><i class="fab fa-pinterest-p"></i></a>
                        <a href="mailto:wasil.zafar@gmail.com" class="social-icon" title="Email"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
            </div>
            <hr class="bg-secondary">
            <div class="row mt-4">
                <div class="col-md-6">
                    <p class="small"><i class="fas fa-icons me-2"></i>Icons from <a href="https://www.flaticon.com/" target="_blank" class="text-light">Flaticon</a> &amp; <a href="https://fontawesome.com/" target="_blank" class="text-light">Font Awesome</a></p>
                    <p class="small mt-3">
                        <a href="/" class="text-light text-decoration-none">Home</a> | 
                        <a href="/disclaimer.html" class="text-light text-decoration-none">Disclaimer</a> | 
                        <a href="/privacy-policy.html" class="text-light text-decoration-none">Privacy Policy</a>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small">Enjoying this content? ☕ <a href="https://buymeacoffee.com/itswzee" target="_blank" class="text-light" style="text-decoration: underline;">Keep me caffeinated</a> to keep the pixels flowing!</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <button id="scrollToTop" class="scroll-to-top"><i class="fas fa-arrow-up"></i></button>
    <div id="categoryIndicator" class="category-indicator"></div>
    <script src="../../../js/cookie-consent.js"></script>
    <script src="../../../js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-nasm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
</body>
</html>
