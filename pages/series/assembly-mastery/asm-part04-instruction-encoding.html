<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="robots" content="index, archive" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Learn x86 instruction encoding: opcodes, prefixes, ModRM, SIB bytes, displacement, immediates. Understand little-endian, REX prefixes, variable-length decoding, and how disassemblers work." />
    <meta name="author" content="Wasil Zafar" />
    <meta name="keywords" content="x86 Instruction Encoding, ModRM, SIB Byte, REX Prefix, Opcode, Little Endian, Variable Length Instructions, Disassembler, Machine Code, Binary Layout" />
    <meta property="og:title" content="x86 Assembly Series Part 4: Instruction Encoding & Binary Layout" />
    <meta property="og:description" content="Understand how x86 assembly instructions are encoded into machine code bytes with opcodes, ModRM, SIB, and REX prefixes." />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2026-02-06" />
    <meta property="article:author" content="Wasil Zafar" />
    <meta property="article:section" content="Technology" />
    
    <title>x86 Assembly Series Part 4: Instruction Encoding & Binary Layout - Wasil Zafar</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" id="prism-theme" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="../../../images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../images/favicon_io/favicon-32x32.png">
    <link rel="manifest" href="../../../images/favicon_io/site.webmanifest">

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', { 'ad_storage': 'denied', 'ad_user_data': 'denied', 'ad_personalization': 'denied', 'analytics_storage': 'denied', 'region': ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE'] });
        gtag('consent', 'default', { 'ad_storage': 'granted', 'ad_user_data': 'granted', 'ad_personalization': 'granted', 'analytics_storage': 'granted' });
    </script>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PBS8M2JR');</script>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PBS8M2JR" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/"><span class="gradient-text">Wasil Zafar</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#skills">Skills</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#certifications">Certifications</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#interests">Interests</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="blog-hero">
        <div class="container py-5">
            <div class="blog-header">
                <a href="/pages/categories/technology.html" class="back-link"><i class="fas fa-arrow-left me-2"></i>Back to Technology</a>
                <h1 class="display-4 fw-bold mb-3">x86 Assembly Series Part 4: Instruction Encoding & Binary Layout</h1>
                <div class="blog-meta">
                    <span><i class="fas fa-calendar me-2"></i>February 6, 2026</span>
                    <span><i class="fas fa-user me-2"></i>Wasil Zafar</span>
                    <span class="reading-time"><i class="fas fa-clock me-1"></i>30 min read</span>
                    <button onclick="window.print()" class="print-btn" title="Print this article"><i class="fas fa-print"></i> Print</button>
                </div>
                <p class="lead">Dive deep into how x86 assembly instructions are encoded into machine code. Learn about opcodes, prefixes, ModRM byte, SIB byte, displacements, immediates, and how disassemblers decode variable-length instructions.</p>
            </div>
        </div>
    </section>

    <button class="toc-toggle-btn" onclick="openNav()" title="Table of Contents"><i class="fas fa-list"></i></button>

    <div id="tocSidenav" class="sidenav-toc">
        <div class="toc-header">
            <h3><i class="fas fa-list me-2"></i>Table of Contents</h3>
            <button class="closebtn" onclick="closeNav()">&times;</button>
        </div>
        <ol>
            <li><a href="#format" onclick="closeNav()">Instruction Format</a>
                <ul>
                    <li><a href="#overview" onclick="closeNav()">Format Overview</a></li>
                    <li><a href="#opcode" onclick="closeNav()">Opcodes</a></li>
                    <li><a href="#prefixes" onclick="closeNav()">Prefixes</a></li>
                </ul>
            </li>
            <li><a href="#modrm-sib" onclick="closeNav()">ModRM & SIB</a>
                <ul>
                    <li><a href="#modrm" onclick="closeNav()">ModRM Byte</a></li>
                    <li><a href="#sib" onclick="closeNav()">SIB Byte</a></li>
                </ul>
            </li>
            <li><a href="#disp-imm" onclick="closeNav()">Displacement & Immediate</a></li>
            <li><a href="#little-endian" onclick="closeNav()">Little-Endian Representation</a></li>
            <li><a href="#rex" onclick="closeNav()">REX Prefixes (x86-64)</a></li>
            <li><a href="#decoding" onclick="closeNav()">Variable-Length Decoding</a></li>
            <li><a href="#disassembly" onclick="closeNav()">How Disassemblers Work</a></li>
        </ol>
    </div>
    <div id="tocOverlay" class="sidenav-overlay" onclick="closeNav()"></div>

    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">

                <div id="format" class="blog-content">
                    <h2><i class="fas fa-puzzle-piece me-2 text-teal"></i>Instruction Format</h2>
                    
                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-microchip me-2"></i>
                        <strong>Key Concept:</strong> x86 instructions are variable-length (1-15 bytes). Understanding encoding is essential for writing shellcode, analyzing malware, and understanding compiler output.
                    </div>

                    <div class="experiment-card">
                        <h4><i class="fas fa-map-signs me-2"></i>Complete Series Navigation</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-teal me-2">25-Part Series</span>
                            <span class="badge bg-crimson">x86 Assembly Mastery</span>
                        </div>
                        <div class="content">
                            <p><strong>Foundation & Environment Setup</strong></p>
                            <ol start="0">
                                <li><a href="asm-part00-environment-setup.html">Development Environment, Tooling & Workflow</a></li>
                                <li><a href="asm-part01-fundamentals.html">Assembly Language Fundamentals & Toolchain Setup</a></li>
                                <li><a href="asm-part02-cpu-architecture.html">x86 CPU Architecture Overview</a></li>
                                <li><a href="asm-part03-registers.html">Registers – Complete Deep Dive</a></li>
                                <li><strong>Instruction Encoding & Binary Layout (This Guide)</strong></li>
                            </ol>
                            <p class="mt-3"><strong>Assemblers, Syntax & Memory</strong></p>
                            <ol start="5">
                                <li><a href="asm-part05-nasm.html">NASM Syntax, Directives & Macros</a></li>
                                <li><a href="asm-part06-masm.html">Complete Assembler Comparison</a></li>
                                <li><a href="asm-part07-memory-addressing.html">Memory Addressing Modes</a></li>
                            </ol>
                            <p class="mt-3"><strong>Control Flow, Stack & Computation</strong></p>
                            <ol start="8">
                                <li><a href="asm-part08-stack-calling.html">Stack Internals & Calling Conventions</a></li>
                                <li><a href="asm-part09-control-flow.html">Control Flow & Procedures</a></li>
                                <li><a href="asm-part10-arithmetic.html">Integer, Bitwise & Arithmetic Operations</a></li>
                            </ol>
                            <p class="mt-3"><strong>Floating Point, SIMD & Performance</strong></p>
                            <ol start="11">
                                <li><a href="asm-part11-floating-point.html">Floating Point & SIMD Foundations</a></li>
                                <li><a href="asm-part12-simd.html">SIMD, Vectorization & Performance</a></li>
                            </ol>
                            <p class="mt-3"><strong>OS Interaction & Debugging</strong></p>
                            <ol start="13">
                                <li><a href="asm-part13-syscalls-interrupts.html">System Calls, Interrupts & Privilege Transitions</a></li>
                                <li><a href="asm-part14-debugging.html">Debugging & Reverse Engineering</a></li>
                                <li><a href="asm-part15-linking.html">Linking, Relocation & Loader Behavior</a></li>
                            </ol>
                            <p class="mt-3"><strong>Advanced Architecture & Interoperability</strong></p>
                            <ol start="16">
                                <li><a href="asm-part16-long-mode.html">x86-64 Long Mode & Advanced Features</a></li>
                                <li><a href="asm-part17-c-interop.html">Assembly + C/C++ Interoperability</a></li>
                                <li><a href="asm-part18-security.html">Memory Protection & Security Concepts</a></li>
                            </ol>
                            <p class="mt-3"><strong>Bare Metal, Kernel & Virtualization</strong></p>
                            <ol start="19">
                                <li><a href="asm-part19-bootloader.html">Bootloaders & Bare-Metal Programming</a></li>
                                <li><a href="asm-part20-kernel.html">Kernel-Level Assembly</a></li>
                                <li><a href="asm-part21-qemu.html">Complete Emulator & Simulator Guide</a></li>
                            </ol>
                            <p class="mt-3"><strong>CPU Microarchitecture & Optimization</strong></p>
                            <ol start="22">
                                <li><a href="asm-part22-optimization.html">Advanced Optimization & CPU Internals</a></li>
                            </ol>
                            <p class="mt-3"><strong>Real-World Application & Mastery</strong></p>
                            <ol start="23">
                                <li><a href="asm-part23-projects.html">Real-World Assembly Projects</a></li>
                                <li><a href="asm-part24-capstone.html">Assembly Mastery Capstone</a></li>
                            </ol>
                        </div>
                    </div>

                    <h3 id="overview">Format Overview</h3>
                    
                    <div class="experiment-card">
                        <div class="card-meta mb-2"><span class="badge bg-teal text-white">Structure</span></div>
                        <h4>x86 Instruction Layout</h4>
                        <pre><code class="language-bash">[Prefixes] [REX] [Opcode] [ModRM] [SIB] [Displacement] [Immediate]
 0-4 bytes  0-1   1-3      0-1     0-1    0,1,2,4        0,1,2,4</code></pre>
                        <p>Each component is optional depending on the instruction. Only the opcode is always present.</p>
                    </div>

                    <h3 id="opcode">Opcodes</h3>
                    
                    <p>The opcode identifies the operation to perform. Opcodes can be 1, 2, or 3 bytes:</p>

                    <pre><code class="language-plaintext">1-byte opcodes: Most common instructions
  90       = NOP
  C3       = RET
  50-57    = PUSH reg (reg encoded in opcode itself)
  B8-BF    = MOV reg, imm32 (reg encoded in low 3 bits)

2-byte opcodes: 0F prefix
  0F 84    = JE rel32 (conditional jump)
  0F AF    = IMUL r32, r/m32
  0F B6    = MOVZX

3-byte opcodes: 0F 38 or 0F 3A prefix
  0F 38 F0 = MOVBE (byte-swap load)
  0F 3A 0F = PALIGNR (SSSE3 shuffle)</code></pre>

                    <h4>Opcode Maps</h4>

                    <pre><code class="language-plaintext">Primary opcode byte (partial map):

        x0   x1   x2   x3   x4   x5   x6   x7   x8   x9   xA   xB   xC   xD   xE   xF
  0x  ADD  ADD  ADD  ADD  ADD  ADD  PUSH POP  OR   OR   OR   OR   OR   OR  PUSH 2-byte
  1x  ADC  ADC  ADC  ADC  ADC  ADC  PUSH POP  SBB  SBB  SBB  SBB  SBB  SBB  PUSH POP
  ...
  5x  PUSH PUSH PUSH PUSH PUSH PUSH PUSH PUSH POP  POP  POP  POP  POP  POP  POP  POP
  ...
  Bx  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV  MOV</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-flask me-2"></i>Exercise: Decode an Opcode</h4>
                        <div class="content">
                            <pre><code class="language-bash"># Disassemble a single instruction
echo -ne '\xB8\x2A\x00\x00\x00' | ndisasm -b 64 -
# Output: mov eax,0x2a

# Breakdown: B8 = MOV EAX, imm32 (B8 + register 0)
# 2A 00 00 00 = 0x0000002A in little-endian = 42</code></pre>
                        </div>
                    </div>

                    <h3 id="prefixes">Instruction Prefixes</h3>
                    
                    <p>Prefixes modify instruction behavior. They must appear before the opcode:</p>

                    <h4>Legacy Prefix Groups</h4>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Group</th>
                                <th>Bytes</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Group 1 (Lock/Rep)</td>
                                <td><code>F0</code>, <code>F2</code>, <code>F3</code></td>
                                <td>LOCK, REPNE/REPNZ, REP/REPE/REPZ</td>
                            </tr>
                            <tr>
                                <td>Group 2 (Segment)</td>
                                <td><code>26</code>, <code>2E</code>, <code>36</code>, <code>3E</code>, <code>64</code>, <code>65</code></td>
                                <td>ES, CS, SS, DS, FS, GS override</td>
                            </tr>
                            <tr>
                                <td>Group 3 (Operand Size)</td>
                                <td><code>66</code></td>
                                <td>Toggle 16/32-bit operand size</td>
                            </tr>
                            <tr>
                                <td>Group 4 (Address Size)</td>
                                <td><code>67</code></td>
                                <td>Toggle 32/64-bit address size</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Operand-Size Override (66h)</h4>

                    <pre><code class="language-nasm">; In 64-bit mode, default operand size is 32-bit
mov eax, [rbx]           ; B8 XX XX XX XX  (32-bit)
mov ax, [rbx]            ; 66 8B 03        (66h makes it 16-bit)
mov rax, [rbx]           ; 48 8B 03        (REX.W makes it 64-bit)</code></pre>

                    <h4>Rep Prefixes for String Operations</h4>

                    <pre><code class="language-nasm">; F3 = REP prefix
rep movsb    ; F3 A4 - Copy RCX bytes from [RSI] to [RDI]
rep stosq    ; F3 48 AB - Fill RCX quadwords at [RDI] with RAX

; F2 = REPNE prefix
repne scasb  ; F2 AE - Scan for AL in [RDI], stop when found</code></pre>

                    <h4>LOCK Prefix for Atomics</h4>

                    <pre><code class="language-nasm">; F0 = LOCK prefix (guarantees atomic read-modify-write)
lock inc dword [counter]     ; F0 FF 05 ... - Atomic increment
lock cmpxchg [mutex], ecx    ; F0 0F B1 0D ... - Atomic compare-exchange</code></pre>

                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Prefix Rules:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Only one prefix from each group is allowed</li>
                            <li>Order within groups doesn't matter (but conventional order helps disassemblers)</li>
                            <li>Invalid LOCK usage causes #UD (Undefined Opcode) exception</li>
                            <li>66h prefix repurposed for SSE2 double-precision FP</li>
                        </ul>
                    </div>
                </div>

                <div id="modrm-sib" class="blog-content mt-5">
                    <h2><i class="fas fa-th me-2 text-teal"></i>ModRM & SIB Bytes</h2>
                    
                    <h3 id="modrm">ModRM Byte Encoding</h3>
                    
                    <div class="experiment-card">
                        <div class="card-meta mb-2"><span class="badge bg-crimson text-white">Encoding</span></div>
                        <h4>ModRM Structure (8 bits)</h4>
                        <pre><code class="language-bash">| Mod (2 bits) | Reg (3 bits) | R/M (3 bits) |
|    7-6       |     5-3      |     2-0      |</code></pre>
                        <ul>
                            <li><strong>Mod:</strong> Addressing mode (00=memory, 01/10=memory+disp, 11=register)</li>
                            <li><strong>Reg:</strong> Register operand or opcode extension</li>
                            <li><strong>R/M:</strong> Register/Memory operand</li>
                        </ul>
                    </div>

                    <h3 id="sib">SIB Byte (Scale-Index-Base)</h3>
                    
                    <p>The SIB byte enables complex addressing modes: <code>[base + index*scale + disp]</code></p>

                    <pre><code class="language-plaintext">SIB Structure (8 bits):
| Scale (2 bits) | Index (3 bits) | Base (3 bits) |
|     7-6        |      5-3       |      2-0      |

Scale values:
  00 = ×1 (no scaling)
  01 = ×2
  10 = ×4
  11 = ×8

Special cases:
  Index = 100 (RSP): No index register used
  Base = 101 with Mod=00: No base, displacement only (RIP-relative)</code></pre>

                    <h4>SIB Examples</h4>

                    <pre><code class="language-nasm">; Array access: arr[i*4]
mov eax, [rbx + rcx*4]        ; SIB = 10_001_011 = 0x8B
                               ; Scale=10(×4), Index=001(RCX), Base=011(RBX)

; 2D array: arr[row][col] where sizeof(row) = 8
mov eax, [rdi + rsi*8 + 16]   ; Base=RDI, Index=RSI, Scale=8, Disp=16

; No base, just scaled index + displacement
mov eax, [rcx*4 + table]      ; ModRM Mod=00, R/M=100 triggers SIB
                               ; SIB Base=101 means no base, use disp32</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-calculator me-2"></i>Decode Challenge</h4>
                        <div class="content">
                            <pre><code class="language-bash"># Instruction: 8B 04 8D 00 00 00 00
# 8B = MOV r32, r/m32
# ModRM 04 = Mod=00, Reg=000(EAX), R/M=100(SIB follows)
# SIB 8D = Scale=10(×4), Index=001(ECX), Base=101(disp32, no base)
# Disp32 = 00 00 00 00
# Result: mov eax, [ecx*4 + 0x0]</code></pre>
                        </div>
                    </div>

                    <div class="highlight-box">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Why SIB Matters:</strong> Array indexing (<code>arr[i]</code>) compiles to scaled addressing. Understanding SIB helps you read disassembly and optimize memory access patterns for cache efficiency.
                    </div>
                </div>

                <div id="disp-imm" class="blog-content mt-5">
                    <h2><i class="fas fa-hashtag me-2 text-teal"></i>Displacement & Immediate</h2>
                    
                    <p>These fields encode constant values embedded in the instruction.</p>

                    <h3>Displacement (Memory Offset)</h3>

                    <pre><code class="language-plaintext">Displacement size depends on ModRM Mod field:
  Mod = 00: No displacement (except special cases)
  Mod = 01: 8-bit signed displacement (sign-extended)
  Mod = 10: 32-bit displacement (or 16-bit in 16-bit mode)
  Mod = 11: No memory access (register-to-register)</code></pre>

                    <pre><code class="language-nasm">; No displacement
mov eax, [rbx]            ; ModRM = 03 (Mod=00)

; 8-bit displacement (efficient for small offsets)
mov eax, [rbx + 8]        ; ModRM = 43 (Mod=01), Disp8 = 08

; 32-bit displacement (required for large offsets)
mov eax, [rbx + 0x1000]   ; ModRM = 83 (Mod=10), Disp32 = 00 10 00 00

; The assembler picks the smallest encoding automatically</code></pre>

                    <h3>Immediate Values</h3>

                    <pre><code class="language-nasm">; Immediate size matches operand size (usually)
mov al, 42               ; B0 2A  (8-bit immediate)
mov ax, 1000             ; 66 B8 E8 03  (16-bit, little-endian)
mov eax, 0x12345678      ; B8 78 56 34 12  (32-bit)
mov rax, 0x123456789ABC  ; 48 B8 BC 9A 78 56 34 12 00 00  (64-bit!!)

; Sign-extended immediates save space
add rax, 1               ; 48 83 C0 01  (8-bit sign-extended to 64)
add rax, 0x7FFFFFFF      ; 48 05 FF FF FF 7F  (32-bit sign-ext)
; Note: Can't add 64-bit immediate! Must use mov first</code></pre>

                    <div class="highlight-box highlight-navy">
                        <i class="fas fa-info-circle"></i>
                        <strong>64-bit Immediate Limitation:</strong> Only <code>MOV reg64, imm64</code> supports full 64-bit immediates. Other instructions use 32-bit sign-extended immediates. This is why <code>mov rax, big_constant; add rbx, rax</code> is sometimes needed.
                    </div>
                </div>

                <div id="little-endian" class="blog-content mt-5">
                    <h2><i class="fas fa-exchange-alt me-2 text-teal"></i>Little-Endian Representation</h2>
                    
                    <p>x86 stores multi-byte values with the <strong>least significant byte first</strong>. This affects how you read hex dumps.</p>

                    <h3>Little-Endian vs Big-Endian</h3>

                    <pre><code class="language-plaintext">Value: 0x12345678

Little-Endian (x86):        Big-Endian (Network/MIPS):
Address  Byte               Address  Byte
0x100    78 (LSB)           0x100    12 (MSB)
0x101    56                 0x101    34
0x102    34                 0x102    56
0x103    12 (MSB)           0x103    78 (LSB)

Memory view: 78 56 34 12    Memory view: 12 34 56 78</code></pre>

                    <h3>Practical Implications</h3>

                    <pre><code class="language-nasm">; Instruction: mov eax, 0xDEADBEEF
; Encoding: B8 EF BE AD DE
;           ^^ opcode
;              ^^ ^^ ^^ ^^ immediate in little-endian!

; When you see this in a hex dump:
; 48 C7 C0 2A 00 00 00
; It's: mov rax, 0x0000002A (42 decimal)
; NOT: mov rax, 0x2A000000</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-flask me-2"></i>Exercise: Read Addresses in Hex Dumps</h4>
                        <div class="content">
                            <pre><code class="language-bash"># Disassemble with address display
echo -ne '\xE9\x1B\x00\x00\x00' | ndisasm -b 64 -
# Output: jmp near 0x20

# The offset 0x0000001B + instruction length (5) = 0x20
# Bytes E9 1B 00 00 00 = JMP rel32
# 1B 00 00 00 in little-endian = 0x0000001B</code></pre>
                        </div>
                    </div>

                    <div class="highlight-box">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Network Programming:</strong> Network protocols use big-endian ("network byte order"). Use <code>bswap</code> instruction or <code>htons()</code>/<code>ntohs()</code> functions when sending/receiving multi-byte values over the network.
                    </div>
                </div>

                <div id="rex" class="blog-content mt-5">
                    <h2><i class="fas fa-expand-arrows-alt me-2 text-teal"></i>REX Prefixes (x86-64)</h2>
                    
                    <p>REX prefixes enable 64-bit operands and access to registers R8-R15.</p>

                    <h3>REX Byte Structure</h3>

                    <pre><code class="language-plaintext">REX prefix: 0100 WRXB (0x40-0x4F)

  Bit 3 (W): 64-bit operand size (instead of default 32-bit)
  Bit 2 (R): Extends ModRM.reg to 4 bits (access R8-R15)
  Bit 1 (X): Extends SIB.index to 4 bits
  Bit 0 (B): Extends ModRM.r/m or SIB.base to 4 bits

REX prefix values:
  40 = REX (enables new 8-bit registers like SIL)
  48 = REX.W (64-bit operand)
  41 = REX.B (extended R/M)
  44 = REX.R (extended Reg)
  4D = REX.WRB (64-bit + extended Reg + extended R/M)</code></pre>

                    <h3>REX Examples</h3>

                    <pre><code class="language-nasm">; Without REX
mov eax, ebx              ; 89 D8 (32-bit, uses low 8 registers)

; REX.W for 64-bit operand
mov rax, rbx              ; 48 89 D8 (64-bit)

; REX.R to access R8-R15 in Reg field
mov r8d, eax              ; 44 89 C0 (R8D, 32-bit)
mov r8, rax               ; 4C 89 C0 (R8, 64-bit, REX.WR)

; REX.B to access R8-R15 in R/M field  
mov eax, r8d              ; 41 89 C0
mov rax, r8               ; 49 89 C0 (REX.WB)

; REX.X for SIB index extension
mov eax, [rbx + r8*4]     ; 42 8B 04 83 (REX.X)</code></pre>

                    <h3>REX and 8-bit Registers</h3>

                    <pre><code class="language-nasm">; REX presence changes 8-bit register encoding!
; Without REX: AH, CH, DH, BH accessible (codes 4-7)
; With REX: SPL, BPL, SIL, DIL accessible (codes 4-7)

mov ah, 5                 ; 80 C4 05 (no REX, AH = code 4)
mov spl, 5                ; 40 80 C4 05 (REX enables SPL = code 4)
mov r8b, 5                ; 41 B0 05 (REX.B for R8B)</code></pre>

                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Incompatibility:</strong> You cannot use AH, BH, CH, DH in the same instruction with R8-R15 or the new low-byte registers (SIL, DIL, BPL, SPL). REX presence blocks the high-byte encodings.
                    </div>
                </div>

                <div id="decoding" class="blog-content mt-5">
                    <h2><i class="fas fa-stream me-2 text-teal"></i>Variable-Length Decoding</h2>
                    
                    <p>x86's variable-length instructions (1-15 bytes) create unique challenges for both CPUs and disassemblers.</p>

                    <h3>CPU Decoding Process</h3>

                    <pre><code class="language-plaintext">Modern x86 Decoder Pipeline:

1. Fetch: Load 16-32 bytes from instruction stream
          (aligned fetch, branch prediction critical)

2. Pre-decode: Find instruction boundaries
              - Scan for prefixes (0x40-0x4F = REX, 0x66, 0xF2, etc.)
              - Identify opcode (1, 2, or 3 bytes: 0F, 0F38, 0F3A)
              - Determine if ModRM/SIB/Disp/Imm follow

3. Decode: Convert to micro-ops
          - Simple: 1 µop (mov, add register)
          - Complex: Multiple µops via microcode ROM

4. Queue: Place µops in execution queue</code></pre>

                    <h3>Instruction Length Determination</h3>

                    <pre><code class="language-plaintext">Length Calculation Algorithm:

length = 0

// Count prefixes (Groups 1-4)
while (byte is legacy prefix or REX):
    length++
    advance

// Opcode (1-3 bytes)
if byte == 0x0F:
    length++
    if next == 0x38 or 0x3A:
        length++  // 3-byte opcode
    length++  // 2-byte opcode
else:
    length++  // 1-byte opcode

// ModRM present? (depends on opcode)
if opcode_needs_modrm:
    parse_modrm()
    length++
    if modrm.rm == 100b:  // SIB follows
        length++
    length += displacement_size(modrm.mod)

// Immediate? (depends on opcode)
length += immediate_size(opcode)</code></pre>

                    <h3>Decoding Challenges</h3>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Challenge</th>
                                <th>Problem</th>
                                <th>Solution</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Variable length</td>
                                <td>Can't know length until parsing</td>
                                <td>Speculative pre-decode, large fetch</td>
                            </tr>
                            <tr>
                                <td>Prefix stacking</td>
                                <td>Up to 4 mandatory + REX + VEX</td>
                                <td>Prefix decoder state machine</td>
                            </tr>
                            <tr>
                                <td>Opcode ambiguity</td>
                                <td>Same byte means different things</td>
                                <td>Context-dependent decode tables</td>
                            </tr>
                            <tr>
                                <td>Branch targets</td>
                                <td>May land mid-instruction</td>
                                <td>Can't cache decoded instructions (code morphing)</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="highlight-box">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Self-Modifying Code:</strong> x86 allows code modification, but the CPU's decoded instruction cache must be invalidated. The <code>CPUID</code> instruction is often used as a serializing fence after code modification.
                    </div>
                </div>

                <div id="disassembly" class="blog-content mt-5">
                    <h2><i class="fas fa-search me-2 text-teal"></i>How Disassemblers Work</h2>
                    
                    <p>Disassemblers face the inverse problem: given machine code bytes, recover the original assembly.</p>

                    <h3>Linear Sweep Disassembly</h3>

                    <pre><code class="language-plaintext">Algorithm:
1. Start at entry point
2. Decode instruction, advance by its length
3. Repeat until end of section

Pros: Simple, fast
Cons: Fooled by:
  - Data embedded in code
  - Jump tables
  - Anti-disassembly tricks</code></pre>

                    <pre><code class="language-bash"># objdump uses linear sweep
objdump -d ./binary

# Problem: if code jumps over data, linear sweep reads data as code
# 00001000: jmp 0x1008
# 00001002: db "HELLO"   ← Linear sweep tries to decode as instructions!
# 00001008: mov eax, 1  ← Real code continues</code></pre>

                    <h3>Recursive Descent Disassembly</h3>

                    <pre><code class="language-plaintext">Algorithm:
1. Start at entry point, add to work list
2. While work list not empty:
   a. Pop address
   b. Decode instruction
   c. If unconditional jump: add target to work list
   d. If conditional jump: add both paths
   e. If call: add target AND next instruction
   f. If ret: stop this path

Pros: Follows actual control flow, skips embedded data
Cons:
  - Indirect jumps (jmp rax) can't be resolved statically
  - May miss dead code
  - Doesn't handle computed jump tables easily</code></pre>

                    <h3>Anti-Disassembly Techniques</h3>

                    <pre><code class="language-nasm">; Opaque predicate: always true, but disassembler doesn't know
mov eax, 1
test eax, eax
jz fake_branch        ; Never taken, but disassembler follows it
                      ; Real code here
fake_branch:
  db 0xE8             ; Looks like CALL, corrupts next instruction decode

; Jump into middle of instruction
mov eax, 0x90909090   ; B8 90 90 90 90
jmp $-3               ; Jump to third 90 = NOP, skipping B8</code></pre>

                    <h3>Disassembler Tools</h3>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Tool</th>
                                <th>Method</th>
                                <th>Best For</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>objdump</code></td>
                                <td>Linear sweep</td>
                                <td>Quick inspection, well-formed binaries</td>
                            </tr>
                            <tr>
                                <td><code>ndisasm</code></td>
                                <td>Linear sweep</td>
                                <td>Raw binary blobs, boot sectors</td>
                            </tr>
                            <tr>
                                <td>IDA Pro / Ghidra</td>
                                <td>Recursive + heuristics</td>
                                <td>Malware, obfuscated code, full RE</td>
                            </tr>
                            <tr>
                                <td>Capstone library</td>
                                <td>On-demand</td>
                                <td>Building custom tools, dynamic analysis</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="experiment-card">
                        <h4><i class="fas fa-flask me-2"></i>Exercise: Compare Disassemblers</h4>
                        <div class="content">
                            <pre><code class="language-bash"># Create a binary with embedded data
echo -ne '\xEB\x05HELLO\xB8\x01\x00\x00\x00\xC3' > test.bin

# Linear sweep (ndisasm)
ndisasm -b 64 test.bin
# 00000000  EB05      jmp short 0x7
# 00000002  48        dec eax        ← 'H' decoded as instruction!
# ...

# The jmp should skip "HELLO" but linear sweep decodes it</code></pre>
                        </div>
                    </div>
                </div>

                <div class="blog-content mt-5">
                    <div class="related-posts">
                        <h3><i class="fas fa-book-reader me-2"></i>Continue the Series</h3>
                        <div class="related-post-item">
                            <h5 class="mb-2">Part 3: Registers – Complete Deep Dive</h5>
                            <p class="text-muted small mb-2">Master all x86/x64 registers including GP, segment, control, and debug registers.</p>
                            <a href="asm-part03-registers.html" class="text-decoration-none">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                        </div>
                        <div class="related-post-item">
                            <h5 class="mb-2">Part 5: NASM Syntax, Directives & Macros</h5>
                            <p class="text-muted small mb-2">Master NASM assembler syntax, sections, data directives, and macros.</p>
                            <a href="asm-part05-nasm.html" class="text-decoration-none">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                        </div>
                        <div class="related-post-item">
                            <h5 class="mb-2">Part 6: Complete Assembler Comparison</h5>
                            <p class="text-muted small mb-2">Compare MASM, NASM, and GAS syntax for cross-platform development.</p>
                            <a href="asm-part06-masm.html" class="text-decoration-none">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                        </div>
                    </div>
                </div>

                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="social-media" class="bg-dark text-light py-5">
        <div class="container py-5">
            <div class="row mb-4">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <h5 class="fw-bold mb-3">Let's Connect</h5>
                    <p class="text-light">
                        I'm always interested in sharing content about my interests on different topics. Read disclaimer and feel free to share further.
                    </p>
                </div>
                <div class="col-lg-6">
                    <h5 class="fw-bold mb-3">Follow Me</h5>
                    <div class="social-links d-flex gap-2 flex-wrap">
                        <a href="https://www.facebook.com/wasil.zafar/" target="_blank" class="social-icon" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com/wasilzafar" target="_blank" class="social-icon" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.linkedin.com/in/wasilzafar" target="_blank" class="social-icon" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@wasilzafar" target="_blank" class="social-icon" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://www.instagram.com/itswzee/" target="_blank" class="social-icon" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://in.pinterest.com/wasilz/" target="_blank" class="social-icon" title="Pinterest"><i class="fab fa-pinterest-p"></i></a>
                        <a href="mailto:wasil.zafar@gmail.com" class="social-icon" title="Email"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
            </div>
            <hr class="bg-secondary">
            <div class="row mt-4">
                <div class="col-md-6">
                    <p class="small"><i class="fas fa-icons me-2"></i>Icons from <a href="https://www.flaticon.com/" target="_blank" class="text-light">Flaticon</a> &amp; <a href="https://fontawesome.com/" target="_blank" class="text-light">Font Awesome</a></p>
                    <p class="small mt-3">
                        <a href="/" class="text-light text-decoration-none">Home</a> | 
                        <a href="/disclaimer.html" class="text-light text-decoration-none">Disclaimer</a> | 
                        <a href="/privacy-policy.html" class="text-light text-decoration-none">Privacy Policy</a>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small">Enjoying this content? ☕ <a href="https://buymeacoffee.com/itswzee" target="_blank" class="text-light" style="text-decoration: underline;">Keep me caffeinated</a> to keep the pixels flowing!</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <button id="scrollToTop" class="scroll-to-top"><i class="fas fa-arrow-up"></i></button>
    <div id="categoryIndicator" class="category-indicator"><span id="categoryText"></span></div>
    <script src="../../../js/cookie-consent.js"></script>
    <script src="../../../js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-nasm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
</body>
</html>
