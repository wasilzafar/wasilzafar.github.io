<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Database Mastery Part 2: Advanced SQL & Query Mastery | Wasil Zafar</title>
    <meta name="description" content="Master advanced SQL techniques including CTEs, window functions, stored procedures, triggers, and production-grade query patterns for complex data manipulation.">
    <meta name="keywords" content="advanced SQL, CTE, window functions, ROW_NUMBER, RANK, stored procedures, triggers, recursive queries, SQL optimization">
    <meta name="author" content="Wasil Zafar">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Complete Database Mastery Part 2: Advanced SQL & Query Mastery">
    <meta property="og:description" content="Master advanced SQL techniques including CTEs, window functions, stored procedures, triggers, and production-grade query patterns.">
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2026-01-31">
    <meta property="article:author" content="Wasil Zafar">
    <meta property="article:section" content="Technology">
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../../images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../images/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="../../../images/favicon_io/site.webmanifest">

    <!-- Google Consent Mode v2 -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'analytics_storage': 'denied',
            'region': ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE']
        });
        
        gtag('consent', 'default', {
            'ad_storage': 'granted',
            'ad_user_data': 'granted',
            'ad_personalization': 'granted',
            'analytics_storage': 'granted'
        });
        
        gtag('set', 'url_passthrough', true);
    </script>

    <!-- Google Tag Manager -->
    <script>
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-PBS8M2JR');
    </script>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" />
    
    <!-- Prism.js Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" id="prism-theme" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" id="prism-default" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" id="prism-dark" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-twilight.min.css" id="prism-twilight" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" id="prism-okaidia" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-solarizedlight.min.css" id="prism-solarizedlight" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" />
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PBS8M2JR" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>

    <!-- GDPR Cookie Consent Banner -->
    <div id="cookieBanner" class="light display-bottom" style="display: none;">
        <div id="closeIcon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"></path>
            </svg>
        </div>
        
        <div class="content-wrap">
            <div class="msg-wrap">
                <div class="title-wrap">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20">
                        <path fill="#3B9797" d="M510.52 255.82c-69.97-.85-126.47-57.69-126.47-127.86-70.17 0-127-56.49-127.86-126.45-27.26-4.14-55.13.3-79.72 12.82l-69.13 35.22a132.221 132.221 0 0 0-57.79 57.81l-35.1 68.88a132.645 132.645 0 0 0-12.82 80.95l12.08 76.27a132.521 132.521 0 0 0 37.16 70.37l54.64 54.64a132.036 132.036 0 0 0 70.37 37.16l76.27 12.15c27.51 4.36 55.7-.11 80.95-12.8l68.88-35.08a132.166 132.166 0 0 0 57.79-57.81l35.1-68.88c12.56-24.64 17.01-52.58 12.91-79.91zM176 368c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm32-160c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm160 128c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32z"></path>
                    </svg>
                    <h4 style="margin: 0; font-size: 18px; color: var(--color-navy); font-weight: 700;">Cookie Consent</h4>
                </div>
                <p style="font-size: 14px; line-height: 1.6; color: var(--color-navy); margin-bottom: 15px;">
                    We use cookies to enhance your browsing experience, serve personalized content, and analyze our traffic. 
                    By clicking "Accept All", you consent to our use of cookies. See our 
                    <a href="/privacy-policy.html" style="color: var(--color-teal); border-bottom: 1px dotted var(--color-teal);">Privacy Policy</a> 
                    for more information.
                </p>
                
                <div id="cookieSettings" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14">
                        <path fill="currentColor" d="M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47 0-70.2l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10-5.1-14.8-2.3L380.8 110c-17.9-15.4-38.5-27.3-60.8-35.1V25.8c0-5.6-3.9-10.5-9.4-11.7-36.7-8.2-74.3-7.8-109.2 0-5.5 1.2-9.4 6.1-9.4 11.7V75c-22.2 7.9-42.8 19.8-60.8 35.1L88.7 85.5c-4.9-2.8-11-1.9-14.8 2.3-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4.6 11.2 5.5 14L67.3 221c-4.3 23.2-4.3 47 0 70.2l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10 5.1 14.8 2.3l42.6-24.6c17.9 15.4 38.5 27.3 60.8 35.1v49.2c0 5.6 3.9 10.5 9.4 11.7 36.7 8.2 74.3 7.8 109.2 0 5.5-1.2 9.4-6.1 9.4-11.7v-49.2c22.2-7.9 42.8-19.8 60.8-35.1l42.6 24.6c4.9 2.8 11 1.9 14.8-2.3 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.5-.7-11.3-5.6-14.1zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z"></path>
                    </svg>
                    <span style="margin-left: 5px; font-size: 12px; font-weight: 600; color: var(--color-navy);">Customize Settings</span>
                </div>
                
                <div id="cookieTypes" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(59, 151, 151, 0.2);">
                    <h5 style="font-size: 12px; font-weight: 700; color: var(--color-navy); margin-bottom: 10px; text-transform: uppercase;">Cookie Preferences</h5>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" checked disabled style="margin-top: 2px; margin-right: 8px; cursor: not-allowed;">
                            <div>
                                <strong style="font-size: 13px; color: var(--color-navy); display: block; margin-bottom: 2px;">Essential Cookies (Required)</strong>
                                <span style="font-size: 12px; color: #666;">Necessary for the website to function properly.</span>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" id="analyticsCookies" checked style="margin-top: 2px; margin-right: 8px;">
                            <div>
                                <strong style="font-size: 13px; color: var(--color-navy); display: block; margin-bottom: 2px;">Analytics Cookies</strong>
                                <span style="font-size: 12px; color: #666;">Help us understand how you interact with the website.</span>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" id="marketingCookies" style="margin-top: 2px; margin-right: 8px;">
                            <div>
                                <strong style="font-size: 13px; color: var(--color-navy); display: block; margin-bottom: 2px;">Marketing Cookies</strong>
                                <span style="font-size: 12px; color: #666;">Used to deliver relevant advertisements.</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="btn-wrap">
                <button id="cookieAccept" style="background: var(--color-teal); color: white; font-weight: 600;">Accept All</button>
                <button id="cookieReject" style="background: transparent; color: var(--color-navy); border: 2px solid var(--color-teal); font-weight: 600;">Reject All</button>
                <button id="cookieSave" style="background: var(--color-blue); color: white; font-weight: 600; display: none;">Save Preferences</button>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <span class="gradient-text">Wasil Zafar</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#skills">Skills</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#certifications">Certifications</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#interests">Interests</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="blog-hero">
        <div class="container py-5">
            <div class="blog-header">
                <a href="/pages/categories/technology.html" class="back-link"><i class="fas fa-arrow-left me-2"></i>Back to Technology</a>
                <h1 class="display-4 fw-bold mb-3">Complete Database Mastery Part 2: Advanced SQL & Query Mastery</h1>
                <div class="blog-meta">
                    <span><i class="fas fa-calendar me-2"></i>January 31, 2026</span>
                    <span><i class="fas fa-user me-2"></i>Wasil Zafar</span>
                    <span class="reading-time"><i class="fas fa-clock me-1"></i>40 min read</span>
                    <button onclick="window.print()" class="print-btn" title="Print this article"><i class="fas fa-print"></i> Print</button>
                </div>
                <p class="lead">Master advanced SQL techniques including CTEs, window functions, stored procedures, triggers, and production-grade query patterns for complex data manipulation and analysis.</p>
            </div>
        </div>
    </section>

    <!-- Table of Contents Toggle Button -->
    <button class="toc-toggle-btn" onclick="openNav()" title="Table of Contents" aria-label="Open Table of Contents">
        <i class="fas fa-list"></i>
    </button>

    <!-- Side Navigation Overlay -->
    <div id="tocSidenav" class="sidenav-toc">
        <div class="toc-header">
            <h3><i class="fas fa-list me-2"></i>Table of Contents</h3>
            <button class="closebtn" onclick="closeNav()" aria-label="Close Table of Contents">&times;</button>
        </div>
        <ol>
            <li>
                <a href="#introduction" onclick="closeNav()">Introduction</a>
                <ul>
                    <li><a href="#introduction" onclick="closeNav()">Beyond Basic SQL</a></li>
                    <li><a href="#series-nav" onclick="closeNav()">Series Navigation</a></li>
                </ul>
            </li>
            <li>
                <a href="#subqueries" onclick="closeNav()">Subqueries</a>
                <ul>
                    <li><a href="#scalar-subqueries" onclick="closeNav()">Scalar Subqueries</a></li>
                    <li><a href="#correlated-subqueries" onclick="closeNav()">Correlated Subqueries</a></li>
                </ul>
            </li>
            <li>
                <a href="#ctes" onclick="closeNav()">Common Table Expressions</a>
                <ul>
                    <li><a href="#basic-ctes" onclick="closeNav()">Basic CTEs</a></li>
                    <li><a href="#recursive-ctes" onclick="closeNav()">Recursive CTEs</a></li>
                </ul>
            </li>
            <li>
                <a href="#window-functions" onclick="closeNav()">Window Functions</a>
                <ul>
                    <li><a href="#row-number-rank" onclick="closeNav()">ROW_NUMBER & RANK</a></li>
                    <li><a href="#partition-by" onclick="closeNav()">PARTITION BY</a></li>
                    <li><a href="#running-totals" onclick="closeNav()">Running Totals & Aggregates</a></li>
                </ul>
            </li>
            <li>
                <a href="#set-operations" onclick="closeNav()">Set Operations</a>
                <ul>
                    <li><a href="#union" onclick="closeNav()">UNION</a></li>
                    <li><a href="#intersect-except" onclick="closeNav()">INTERSECT & EXCEPT</a></li>
                </ul>
            </li>
            <li>
                <a href="#stored-procedures" onclick="closeNav()">Stored Procedures & Functions</a>
                <ul>
                    <li><a href="#procedures" onclick="closeNav()">Creating Procedures</a></li>
                    <li><a href="#functions" onclick="closeNav()">User-Defined Functions</a></li>
                </ul>
            </li>
            <li>
                <a href="#triggers" onclick="closeNav()">Triggers & Events</a>
                <ul>
                    <li><a href="#trigger-basics" onclick="closeNav()">Trigger Fundamentals</a></li>
                    <li><a href="#event-driven" onclick="closeNav()">Event-Driven SQL</a></li>
                </ul>
            </li>
            <li><a href="#json-support" onclick="closeNav()">JSON Support in SQL</a></li>
            <li><a href="#production-sql" onclick="closeNav()">Production-Grade SQL</a></li>
            <li><a href="#conclusion" onclick="closeNav()">Conclusion & Next Steps</a></li>
        </ol>
    </div>

    <!-- Overlay Backdrop -->
    <div id="tocOverlay" class="sidenav-overlay" onclick="closeNav()"></div>

    <!-- Main Content -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">

                <!-- Introduction -->
                <div id="introduction" class="blog-content">
                    <h2><i class="fas fa-rocket me-2 text-teal"></i>Introduction: Beyond Basic SQL</h2>
                    
                    <p>In <a href="database-mastery-sql-fundamentals.html">Part 1</a>, we mastered SQL fundamentals. Now we're leveling up to <strong>advanced query techniques</strong> that separate junior developers from senior engineers—CTEs, window functions, stored procedures, and patterns for writing clean, maintainable SQL.</p>

                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-sitemap me-2"></i>
                        <strong>Series Context:</strong> This is <strong>Part 2 of 15</strong> in the Complete Database Mastery series. We're building on fundamentals to unlock powerful query capabilities.
                    </div>

                    <div class="experiment-card" id="series-nav">
                        <h4><i class="fas fa-map-signs me-2"></i>Complete Series Navigation</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-teal me-2">15-Part Series</span>
                            <span class="badge bg-crimson">Database Mastery</span>
                        </div>
                        <div class="content">
                            <ol>
                                <li><a href="database-mastery-sql-fundamentals.html"><strong>Part 1:</strong> SQL Fundamentals & Syntax</a> — Database basics, CRUD operations, joins, constraints</li>
                                <li><strong>Part 2: Advanced SQL & Query Mastery (This Guide)</strong> — CTEs, window functions, stored procedures</li>
                                <li><a href="database-mastery-postgresql.html"><strong>Part 3:</strong> PostgreSQL Deep Dive</a> — Advanced types, indexing, extensions, tuning</li>
                                <li><a href="database-mastery-mysql-mariadb.html"><strong>Part 4:</strong> MySQL & MariaDB</a> — Storage engines, replication, optimization</li>
                                <li><a href="database-mastery-transactions-concurrency.html"><strong>Part 5:</strong> Transactions & Concurrency</a> — ACID, isolation levels, locking, MVCC</li>
                                <li><a href="database-mastery-query-optimization.html"><strong>Part 6:</strong> Query Optimization & Indexing</a> — EXPLAIN plans, index design, performance</li>
                                <li><a href="database-mastery-data-modeling.html"><strong>Part 7:</strong> Data Modeling & Normalization</a> — ERDs, normal forms, schema design</li>
                                <li><a href="database-mastery-mongodb-nosql.html"><strong>Part 8:</strong> MongoDB & Document Databases</a> — NoSQL, aggregation, sharding</li>
                                <li><a href="database-mastery-redis-caching.html"><strong>Part 9:</strong> Redis & Caching Strategies</a> — Data structures, caching patterns, pub/sub</li>
                                <li><a href="database-mastery-administration-migrations.html"><strong>Part 10:</strong> Database Administration & Migrations</a> — Backup, versioning, maintenance</li>
                                <li><a href="database-mastery-scaling-distributed.html"><strong>Part 11:</strong> Scaling & Distributed Systems</a> — Replication, sharding, CAP theorem</li>
                                <li><a href="database-mastery-cloud-databases.html"><strong>Part 12:</strong> Cloud Databases & Managed Services</a> — AWS, Azure, GCP database offerings</li>
                                <li><a href="database-mastery-security-governance.html"><strong>Part 13:</strong> Database Security & Governance</a> — Encryption, access control, compliance</li>
                                <li><a href="database-mastery-warehousing-analytics.html"><strong>Part 14:</strong> Data Warehousing & Analytics</a> — OLAP, star schemas, columnar DBs</li>
                                <li><a href="database-mastery-capstone-projects.html"><strong>Part 15:</strong> Capstone Projects</a> — Portfolio-ready database implementations</li>
                            </ol>
                        </div>
                    </div>

                    <!-- CONTENT PLACEHOLDER -->
                    <p>These advanced techniques will help you:</p>
                    <ul>
                        <li><strong>Write cleaner queries</strong> using CTEs instead of nested subqueries</li>
                        <li><strong>Solve ranking problems</strong> with window functions (ROW_NUMBER, RANK, DENSE_RANK)</li>
                        <li><strong>Handle hierarchical data</strong> using recursive queries</li>
                        <li><strong>Encapsulate business logic</strong> in stored procedures and triggers</li>
                        <li><strong>Work with semi-structured data</strong> using JSON functions</li>
                    </ul>
                    
                    <div class="highlight-box">
                        <i class="fas fa-terminal me-2"></i>
                        <strong>Practice Environment:</strong> All examples use PostgreSQL syntax (most portable), with MySQL/SQL Server variations noted where they differ. Try these queries in your local database or use <a href="https://www.db-fiddle.com/" target="_blank">DB Fiddle</a> online.
                    </div>

                </div>

                <!-- Subqueries Section -->
                <div id="subqueries" class="blog-content mt-5">
                    <h2><i class="fas fa-layer-group me-2 text-teal"></i>Subqueries</h2>
                    
                    <p>A <strong>subquery</strong> is a query nested inside another query. Think of it as asking a question that requires answering another question first—like "Find all customers who spent more than the average order value" (you need to calculate the average first).</p>
                    
                    <h3 id="scalar-subqueries">Scalar Subqueries</h3>
                    
                    <p>A <strong>scalar subquery</strong> returns exactly one value (one row, one column). You can use it anywhere a single value is expected—in SELECT, WHERE, or even inside expressions.</p>
                    
<pre><code class="language-sql">-- Using our sample tables
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    category VARCHAR(50),
    price DECIMAL(10,2)
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INT,
    product_id INT REFERENCES products(id),
    quantity INT,
    unit_price DECIMAL(10,2)
);

INSERT INTO products (name, category, price) VALUES
    ('Laptop', 'Electronics', 999.99),
    ('Mouse', 'Electronics', 29.99),
    ('Desk Chair', 'Furniture', 199.99),
    ('Notebook', 'Office', 4.99),
    ('Monitor', 'Electronics', 349.99);

-- Scalar subquery in SELECT (compare each price to average)
SELECT 
    name,
    price,
    (SELECT AVG(price) FROM products) AS avg_price,
    price - (SELECT AVG(price) FROM products) AS diff_from_avg
FROM products;

-- Scalar subquery in WHERE (products above average price)
SELECT name, price
FROM products
WHERE price > (SELECT AVG(price) FROM products);

-- Result:
-- name       | price
-- -----------+--------
-- Laptop     | 999.99
-- Monitor    | 349.99
</code></pre>

                    <h3 id="correlated-subqueries">Correlated Subqueries</h3>
                    
                    <p>A <strong>correlated subquery</strong> references the outer query—it runs once for each row in the outer query. This is powerful but can be slow on large datasets.</p>
                    
<pre><code class="language-sql">-- Find products that are the most expensive in their category
SELECT p1.name, p1.category, p1.price
FROM products p1
WHERE p1.price = (
    SELECT MAX(p2.price)
    FROM products p2
    WHERE p2.category = p1.category  -- Correlation: references outer query
);

-- Find customers who have placed more orders than average
SELECT c.id, c.first_name, c.last_name,
       (SELECT COUNT(*) FROM orders o WHERE o.customer_id = c.id) AS order_count
FROM customers c
WHERE (SELECT COUNT(*) FROM orders o WHERE o.customer_id = c.id) > 
      (SELECT AVG(order_count) FROM (
          SELECT COUNT(*) AS order_count 
          FROM orders 
          GROUP BY customer_id
      ) subq);
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-exchange-alt me-2"></i>EXISTS vs IN vs JOIN</h4>
                        <div class="content">
                            <p>Three ways to filter based on related table data—each with different performance characteristics:</p>
                            
<pre><code class="language-sql">-- Using IN (good for small result sets)
SELECT * FROM customers
WHERE id IN (SELECT customer_id FROM orders WHERE total > 1000);

-- Using EXISTS (often faster for large tables - stops at first match)
SELECT * FROM customers c
WHERE EXISTS (
    SELECT 1 FROM orders o 
    WHERE o.customer_id = c.id AND o.total > 1000
);

-- Using JOIN (most flexible, can return columns from both tables)
SELECT DISTINCT c.* 
FROM customers c
INNER JOIN orders o ON c.id = o.customer_id
WHERE o.total > 1000;
</code></pre>
                            
                            <table class="table table-bordered mt-3">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Method</th>
                                        <th>Best For</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>IN</code></td>
                                        <td>Small subquery results</td>
                                        <td>Can be slow with large lists; handles NULLs differently</td>
                                    </tr>
                                    <tr>
                                        <td><code>EXISTS</code></td>
                                        <td>Checking existence only</td>
                                        <td>Short-circuits on first match; often most efficient</td>
                                    </tr>
                                    <tr>
                                        <td><code>JOIN</code></td>
                                        <td>Need columns from both tables</td>
                                        <td>May return duplicates without DISTINCT</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Performance Warning:</strong> Correlated subqueries execute once per row. On a 1M row table, that's 1M executions of the inner query! Use JOINs or window functions instead when possible.
                    </div>
                </div>

                <!-- CTEs Section -->
                <div id="ctes" class="blog-content mt-5">
                    <h2><i class="fas fa-sitemap me-2 text-teal"></i>Common Table Expressions (CTEs)</h2>
                    
                    <p>CTEs are named temporary result sets that exist only within a single query. Think of them as "query variables"—they make complex queries readable by breaking them into logical, named steps.</p>
                    
                    <h3 id="basic-ctes">Basic CTEs</h3>
                    
<pre><code class="language-sql">-- Basic CTE syntax
WITH cte_name AS (
    -- Your query here
    SELECT column1, column2 FROM some_table
)
SELECT * FROM cte_name;

-- Real example: Find customers with above-average lifetime value
WITH customer_totals AS (
    SELECT 
        customer_id,
        SUM(total) AS lifetime_value,
        COUNT(*) AS order_count
    FROM orders
    GROUP BY customer_id
),
average_value AS (
    SELECT AVG(lifetime_value) AS avg_value FROM customer_totals
)
SELECT 
    c.first_name,
    c.last_name,
    ct.lifetime_value,
    ct.order_count,
    a.avg_value,
    ct.lifetime_value - a.avg_value AS above_average_by
FROM customers c
JOIN customer_totals ct ON c.id = ct.customer_id
CROSS JOIN average_value a
WHERE ct.lifetime_value > a.avg_value
ORDER BY ct.lifetime_value DESC;
</code></pre>

                    <div class="highlight-box">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>CTE vs Subquery:</strong> CTEs and subqueries produce the same results, but CTEs are:
                        <ul style="margin-top: 10px;">
                            <li>More readable (named, at the top of the query)</li>
                            <li>Reusable within the same query (reference multiple times)</li>
                            <li>Easier to debug (test each CTE independently)</li>
                            <li>Required for recursive queries</li>
                        </ul>
                    </div>

<pre><code class="language-sql">-- Multiple CTEs chained together (monthly sales analysis)
WITH monthly_sales AS (
    SELECT 
        DATE_TRUNC('month', order_date) AS month,
        SUM(total) AS revenue,
        COUNT(*) AS orders
    FROM orders
    WHERE order_date >= '2024-01-01'
    GROUP BY DATE_TRUNC('month', order_date)
),
monthly_growth AS (
    SELECT 
        month,
        revenue,
        orders,
        LAG(revenue) OVER (ORDER BY month) AS prev_revenue,
        revenue - LAG(revenue) OVER (ORDER BY month) AS revenue_change
    FROM monthly_sales
),
categorized AS (
    SELECT 
        *,
        CASE 
            WHEN revenue_change > 0 THEN 'Growth'
            WHEN revenue_change < 0 THEN 'Decline'
            ELSE 'Flat'
        END AS trend
    FROM monthly_growth
)
SELECT * FROM categorized ORDER BY month;
</code></pre>

                    <h3 id="recursive-ctes">Recursive CTEs</h3>
                    
                    <p>Recursive CTEs query hierarchical or tree-structured data—like org charts, categories/subcategories, or graph traversal. They consist of two parts:</p>
                    <ol>
                        <li><strong>Base case (anchor):</strong> The starting point (non-recursive)</li>
                        <li><strong>Recursive case:</strong> References itself to build upon previous results</li>
                    </ol>
                    
<pre><code class="language-sql">-- Employee hierarchy (org chart)
CREATE TABLE employees_org (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    manager_id INT REFERENCES employees_org(id),
    title VARCHAR(100)
);

INSERT INTO employees_org (name, manager_id, title) VALUES
    ('Alice', NULL, 'CEO'),           -- id=1
    ('Bob', 1, 'VP Engineering'),      -- id=2
    ('Carol', 1, 'VP Sales'),          -- id=3
    ('Dave', 2, 'Dev Manager'),        -- id=4
    ('Eve', 2, 'QA Manager'),          -- id=5
    ('Frank', 4, 'Senior Developer'),  -- id=6
    ('Grace', 4, 'Developer');         -- id=7

-- Find all employees under Bob (VP Engineering)
WITH RECURSIVE org_tree AS (
    -- Base case: Start with Bob
    SELECT id, name, manager_id, title, 1 AS level, name AS path
    FROM employees_org
    WHERE name = 'Bob'
    
    UNION ALL
    
    -- Recursive case: Find direct reports
    SELECT e.id, e.name, e.manager_id, e.title, 
           ot.level + 1,
           ot.path || ' > ' || e.name
    FROM employees_org e
    INNER JOIN org_tree ot ON e.manager_id = ot.id
)
SELECT * FROM org_tree ORDER BY level, name;

-- Result:
-- id | name  | manager_id | title           | level | path
-- ---+-------+------------+-----------------+-------+------------------
-- 2  | Bob   | 1          | VP Engineering  | 1     | Bob
-- 4  | Dave  | 2          | Dev Manager     | 2     | Bob > Dave
-- 5  | Eve   | 2          | QA Manager      | 2     | Bob > Eve
-- 6  | Frank | 4          | Senior Developer| 3     | Bob > Dave > Frank
-- 7  | Grace | 4          | Developer       | 3     | Bob > Dave > Grace
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-folder-tree me-2"></i>Real-World Use Case: Category Breadcrumbs</h4>
                        <div class="content">
<pre><code class="language-sql">-- E-commerce category hierarchy
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    parent_id INT REFERENCES categories(id)
);

INSERT INTO categories (name, parent_id) VALUES
    ('Electronics', NULL),
    ('Computers', 1),
    ('Laptops', 2),
    ('Gaming Laptops', 3);

-- Generate breadcrumb: Electronics > Computers > Laptops > Gaming Laptops
WITH RECURSIVE breadcrumb AS (
    SELECT id, name, parent_id, name AS path
    FROM categories
    WHERE name = 'Gaming Laptops'
    
    UNION ALL
    
    SELECT c.id, c.name, c.parent_id, c.name || ' > ' || b.path
    FROM categories c
    INNER JOIN breadcrumb b ON c.id = b.parent_id
)
SELECT path FROM breadcrumb WHERE parent_id IS NULL;
-- Result: Electronics > Computers > Laptops > Gaming Laptops
</code></pre>
                        </div>
                    </div>
                    
                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Infinite Loop Warning:</strong> Recursive CTEs can run forever if your data has cycles! Always add a termination condition like <code>WHERE level < 100</code> or use a cycle-detection column.
                    </div>
                </div>

                <!-- Window Functions Section -->
                <div id="window-functions" class="blog-content mt-5">
                    <h2><i class="fas fa-window-maximize me-2 text-teal"></i>Window Functions</h2>
                    
                    <p>Window functions perform calculations across a set of rows related to the current row—without collapsing them like GROUP BY does. They're your secret weapon for rankings, running totals, and comparisons.</p>
                    
                    <div class="highlight-box">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Window vs GROUP BY:</strong> GROUP BY collapses multiple rows into one (10 orders → 1 summary row). Window functions keep all rows and add a calculation column (10 orders → 10 rows, each with a rank).
                    </div>
                    
                    <h3 id="row-number-rank">ROW_NUMBER, RANK & DENSE_RANK</h3>
                    
                    <p>These functions assign a number to each row based on ordering. The difference is how they handle ties:</p>
                    
<pre><code class="language-sql">-- Sample data with ties
CREATE TABLE sales_data (
    salesperson VARCHAR(50),
    region VARCHAR(50),
    revenue DECIMAL(10,2)
);

INSERT INTO sales_data VALUES
    ('Alice', 'North', 50000),
    ('Bob', 'North', 45000),
    ('Carol', 'North', 45000),  -- Tie with Bob!
    ('Dave', 'North', 40000),
    ('Eve', 'South', 60000),
    ('Frank', 'South', 55000);

-- Compare the three ranking functions
SELECT 
    salesperson,
    revenue,
    ROW_NUMBER() OVER (ORDER BY revenue DESC) AS row_num,
    RANK() OVER (ORDER BY revenue DESC) AS rank,
    DENSE_RANK() OVER (ORDER BY revenue DESC) AS dense_rank
FROM sales_data;

-- Result:
-- salesperson | revenue | row_num | rank | dense_rank
-- ------------+---------+---------+------+------------
-- Eve         | 60000   | 1       | 1    | 1
-- Frank       | 55000   | 2       | 2    | 2
-- Alice       | 50000   | 3       | 3    | 3
-- Bob         | 45000   | 4       | 4    | 4     ← Same rank as Carol
-- Carol       | 45000   | 5       | 4    | 4     ← Same rank as Bob
-- Dave        | 40000   | 6       | 6    | 5     ← RANK skips 5, DENSE_RANK doesn't
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-medal me-2"></i>When to Use Each</h4>
                        <div class="content">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Function</th>
                                        <th>Handles Ties</th>
                                        <th>Best For</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>ROW_NUMBER()</code></td>
                                        <td>Unique numbers (arbitrary for ties)</td>
                                        <td>Pagination, unique row IDs, deduplication</td>
                                    </tr>
                                    <tr>
                                        <td><code>RANK()</code></td>
                                        <td>Same rank, gaps after ties</td>
                                        <td>Competition rankings (1st, 2nd, 2nd, 4th)</td>
                                    </tr>
                                    <tr>
                                        <td><code>DENSE_RANK()</code></td>
                                        <td>Same rank, no gaps</td>
                                        <td>Continuous rankings (1st, 2nd, 2nd, 3rd)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <h3 id="partition-by">PARTITION BY: Windowing Within Groups</h3>
                    
                    <p><code>PARTITION BY</code> divides the result set into groups (like GROUP BY) but keeps all rows. The window function then applies within each partition independently.</p>
                    
<pre><code class="language-sql">-- Rank salespeople within their region
SELECT 
    salesperson,
    region,
    revenue,
    RANK() OVER (PARTITION BY region ORDER BY revenue DESC) AS region_rank,
    revenue - AVG(revenue) OVER (PARTITION BY region) AS vs_region_avg
FROM sales_data;

-- Result:
-- salesperson | region | revenue | region_rank | vs_region_avg
-- ------------+--------+---------+-------------+--------------
-- Alice       | North  | 50000   | 1           | 5000
-- Bob         | North  | 45000   | 2           | 0
-- Carol       | North  | 45000   | 2           | 0
-- Dave        | North  | 40000   | 4           | -5000
-- Eve         | South  | 60000   | 1           | 2500
-- Frank       | South  | 55000   | 2           | -2500

-- Get top 2 salespeople per region
WITH ranked AS (
    SELECT 
        *,
        ROW_NUMBER() OVER (PARTITION BY region ORDER BY revenue DESC) AS rn
    FROM sales_data
)
SELECT salesperson, region, revenue
FROM ranked
WHERE rn <= 2;
</code></pre>

                    <h3 id="running-totals">Running Totals, Moving Averages & Lag/Lead</h3>
                    
<pre><code class="language-sql">-- Daily sales with running total
CREATE TABLE daily_sales (
    sale_date DATE,
    amount DECIMAL(10,2)
);

INSERT INTO daily_sales VALUES
    ('2024-01-01', 100),
    ('2024-01-02', 150),
    ('2024-01-03', 200),
    ('2024-01-04', 120),
    ('2024-01-05', 180);

-- Running total and moving average
SELECT 
    sale_date,
    amount,
    SUM(amount) OVER (ORDER BY sale_date) AS running_total,
    AVG(amount) OVER (ORDER BY sale_date 
                      ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg_3day,
    amount - LAG(amount) OVER (ORDER BY sale_date) AS daily_change,
    LEAD(amount) OVER (ORDER BY sale_date) AS next_day_amount
FROM daily_sales;

-- Result:
-- sale_date   | amount | running_total | moving_avg_3day | daily_change | next_day
-- ------------+--------+---------------+-----------------+--------------+---------
-- 2024-01-01  | 100    | 100           | 100.00          | NULL         | 150
-- 2024-01-02  | 150    | 250           | 125.00          | 50           | 200
-- 2024-01-03  | 200    | 450           | 150.00          | 50           | 120
-- 2024-01-04  | 120    | 570           | 156.67          | -80          | 180
-- 2024-01-05  | 180    | 750           | 166.67          | 60           | NULL
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-chart-line me-2"></i>Window Frame Specifications</h4>
                        <div class="content">
                            <p>The <code>ROWS BETWEEN</code> clause defines exactly which rows are included in the window:</p>
                            
<pre><code class="language-sql">-- Common window frame patterns
SUM(amount) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
-- All rows from start to current (running total)

AVG(amount) OVER (ORDER BY date ROWS BETWEEN 2 PRECEDING AND CURRENT ROW)
-- Current row + 2 previous (3-day moving average)

AVG(amount) OVER (ORDER BY date ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING)
-- Centered average (previous + current + next)

SUM(amount) OVER (ORDER BY date ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING)
-- Remaining total (current to end)
</code></pre>
                        </div>
                    </div>
                    
                    <div class="highlight-box">
                        <i class="fas fa-magic me-2"></i>
                        <strong>Window Functions Cheat Sheet:</strong>
                        <ul style="margin-top: 10px;">
                            <li><strong>Ranking:</strong> ROW_NUMBER(), RANK(), DENSE_RANK(), NTILE(n)</li>
                            <li><strong>Value Access:</strong> LAG(), LEAD(), FIRST_VALUE(), LAST_VALUE(), NTH_VALUE()</li>
                            <li><strong>Aggregates:</strong> SUM(), AVG(), COUNT(), MIN(), MAX() with OVER()</li>
                            <li><strong>Statistics:</strong> PERCENT_RANK(), CUME_DIST(), PERCENTILE_CONT()</li>
                        </ul>
                    </div>
                </div>

                <!-- Set Operations Section -->
                <div id="set-operations" class="blog-content mt-5">
                    <h2><i class="fas fa-object-group me-2 text-teal"></i>Set Operations</h2>
                    
                    <p>Set operations combine results from multiple queries. Think Venn diagrams: UNION is the full circle, INTERSECT is the overlap, and EXCEPT is what's left.</p>
                    
                    <h3 id="union">UNION & UNION ALL</h3>
                    
                    <p><code>UNION</code> combines results from two queries and removes duplicates. <code>UNION ALL</code> keeps duplicates (faster, no deduplication step).</p>
                    
<pre><code class="language-sql">-- Sample tables
CREATE TABLE employees_us (
    id INT,
    name VARCHAR(100),
    department VARCHAR(50)
);

CREATE TABLE employees_eu (
    id INT,
    name VARCHAR(100),
    department VARCHAR(50)
);

INSERT INTO employees_us VALUES
    (1, 'Alice', 'Engineering'),
    (2, 'Bob', 'Sales'),
    (3, 'Carol', 'Engineering');

INSERT INTO employees_eu VALUES
    (4, 'Dave', 'Engineering'),
    (5, 'Eve', 'Marketing'),
    (3, 'Carol', 'Engineering');  -- Carol works in both regions!

-- UNION removes duplicates
SELECT name, department FROM employees_us
UNION
SELECT name, department FROM employees_eu;

-- Result: 5 rows (Carol appears once)
-- Alice, Bob, Carol, Dave, Eve

-- UNION ALL keeps duplicates
SELECT name, department FROM employees_us
UNION ALL
SELECT name, department FROM employees_eu;

-- Result: 6 rows (Carol appears twice)

-- Combining with additional columns to track source
SELECT name, department, 'US' AS region FROM employees_us
UNION ALL
SELECT name, department, 'EU' AS region FROM employees_eu;
</code></pre>

                    <div class="highlight-box">
                        <i class="fas fa-bolt me-2"></i>
                        <strong>Performance Tip:</strong> Use <code>UNION ALL</code> when you know there are no duplicates or want to keep them. It's faster because it skips the deduplication sort.
                    </div>

                    <h3 id="intersect-except">INTERSECT & EXCEPT</h3>
                    
<pre><code class="language-sql">-- INTERSECT: Only rows that appear in BOTH queries
SELECT name FROM employees_us
INTERSECT
SELECT name FROM employees_eu;

-- Result: Carol (appears in both)

-- Real-world use: Customers who bought from BOTH categories
SELECT customer_id FROM orders
WHERE product_category = 'Electronics'
INTERSECT
SELECT customer_id FROM orders
WHERE product_category = 'Furniture';

-- EXCEPT (MINUS in Oracle): Rows in first query but NOT in second
SELECT name FROM employees_us
EXCEPT
SELECT name FROM employees_eu;

-- Result: Alice, Bob (in US but not EU)

-- Real-world use: Active customers who haven't ordered in 2024
SELECT id FROM customers
WHERE is_active = true
EXCEPT
SELECT DISTINCT customer_id FROM orders
WHERE order_date >= '2024-01-01';
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-exclamation-circle me-2"></i>Set Operation Rules</h4>
                        <div class="content">
                            <ul>
                                <li>Both queries must return the <strong>same number of columns</strong></li>
                                <li>Column data types must be <strong>compatible</strong> (can be implicitly converted)</li>
                                <li>Column names come from the <strong>first query</strong></li>
                                <li>ORDER BY applies to the <strong>final result</strong> (goes at the end)</li>
                            </ul>
                            
<pre><code class="language-sql">-- ❌ ERROR: Different number of columns
SELECT id, name FROM employees_us
UNION
SELECT name FROM employees_eu;

-- ✅ Correct with ORDER BY
SELECT name, department FROM employees_us
UNION
SELECT name, department FROM employees_eu
ORDER BY name;  -- ORDER BY goes at the very end
</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Stored Procedures Section -->
                <div id="stored-procedures" class="blog-content mt-5">
                    <h2><i class="fas fa-cogs me-2 text-teal"></i>Stored Procedures & Functions</h2>
                    
                    <p>Stored procedures and functions encapsulate SQL logic on the database server. They're like API endpoints for your database—reusable, secure, and efficient.</p>
                    
                    <h3 id="procedures">Creating Stored Procedures</h3>
                    
                    <p>A <strong>stored procedure</strong> is a saved set of SQL statements that can accept parameters, perform operations, and optionally return results. They can modify data (INSERT/UPDATE/DELETE).</p>
                    
<pre><code class="language-sql">-- PostgreSQL procedure syntax
CREATE OR REPLACE PROCEDURE transfer_funds(
    sender_id INT,
    receiver_id INT,
    amount DECIMAL(10,2)
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- Check sufficient balance
    IF (SELECT balance FROM accounts WHERE id = sender_id) < amount THEN
        RAISE EXCEPTION 'Insufficient funds';
    END IF;
    
    -- Perform transfer (both must succeed or both fail)
    UPDATE accounts SET balance = balance - amount WHERE id = sender_id;
    UPDATE accounts SET balance = balance + amount WHERE id = receiver_id;
    
    -- Log the transaction
    INSERT INTO transactions (from_account, to_account, amount, transaction_date)
    VALUES (sender_id, receiver_id, amount, CURRENT_TIMESTAMP);
    
    COMMIT;
END;
$$;

-- Call the procedure
CALL transfer_funds(101, 202, 500.00);
</code></pre>

<pre><code class="language-sql">-- MySQL procedure with output parameters
DELIMITER //
CREATE PROCEDURE get_customer_stats(
    IN customer_id INT,
    OUT total_orders INT,
    OUT total_spent DECIMAL(12,2)
)
BEGIN
    SELECT COUNT(*), COALESCE(SUM(total), 0)
    INTO total_orders, total_spent
    FROM orders
    WHERE customer_id = customer_id;
END //
DELIMITER ;

-- Call with output variables
CALL get_customer_stats(1, @orders, @spent);
SELECT @orders, @spent;
</code></pre>

                    <h3 id="functions">User-Defined Functions (UDFs)</h3>
                    
                    <p>Unlike procedures, <strong>functions</strong> must return a value and cannot modify data (in most databases). They can be used inline in queries—like built-in functions.</p>
                    
<pre><code class="language-sql">-- Scalar function: Returns a single value
CREATE OR REPLACE FUNCTION calculate_discount(
    price DECIMAL(10,2),
    discount_pct INT
)
RETURNS DECIMAL(10,2)
LANGUAGE SQL
IMMUTABLE
AS $$
    SELECT price * (1 - discount_pct / 100.0);
$$;

-- Use in queries
SELECT 
    name,
    price,
    calculate_discount(price, 20) AS sale_price
FROM products;

-- Table-returning function
CREATE OR REPLACE FUNCTION get_products_in_range(
    min_price DECIMAL,
    max_price DECIMAL
)
RETURNS TABLE (
    product_id INT,
    product_name VARCHAR,
    price DECIMAL
)
LANGUAGE SQL
AS $$
    SELECT id, name, price
    FROM products
    WHERE price BETWEEN min_price AND max_price
    ORDER BY price;
$$;

-- Use like a table
SELECT * FROM get_products_in_range(50, 200);
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-balance-scale me-2"></i>Procedures vs Functions</h4>
                        <div class="content">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Feature</th>
                                        <th>Stored Procedure</th>
                                        <th>Function (UDF)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Returns</td>
                                        <td>Optional (via OUT params)</td>
                                        <td>Required (single value or table)</td>
                                    </tr>
                                    <tr>
                                        <td>Called via</td>
                                        <td>CALL / EXEC</td>
                                        <td>SELECT (inline in queries)</td>
                                    </tr>
                                    <tr>
                                        <td>Can modify data</td>
                                        <td>Yes (INSERT/UPDATE/DELETE)</td>
                                        <td>Usually no (read-only)</td>
                                    </tr>
                                    <tr>
                                        <td>Transactions</td>
                                        <td>Can control (COMMIT/ROLLBACK)</td>
                                        <td>Cannot control</td>
                                    </tr>
                                    <tr>
                                        <td>Use case</td>
                                        <td>Complex business logic</td>
                                        <td>Calculations, data transformation</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Version Control Challenge:</strong> Stored procedures live in the database, not your Git repo. Use migration tools (Flyway, Liquibase) or keep CREATE statements in versioned .sql files.
                    </div>
                </div>

                <!-- Triggers Section -->
                <div id="triggers" class="blog-content mt-5">
                    <h2><i class="fas fa-bolt me-2 text-teal"></i>Triggers & Events</h2>
                    
                    <p>Triggers are automatic actions that fire when specific database events occur. They're like event listeners for your database—"when X happens, do Y."</p>
                    
                    <h3 id="trigger-basics">Trigger Fundamentals</h3>
                    
<pre><code class="language-sql">-- PostgreSQL trigger: Auto-update timestamp
CREATE OR REPLACE FUNCTION update_modified_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_updated_at
    BEFORE UPDATE ON products
    FOR EACH ROW
    EXECUTE FUNCTION update_modified_timestamp();

-- Now any UPDATE on products automatically sets updated_at
UPDATE products SET price = 99.99 WHERE id = 1;
-- updated_at is now current timestamp!
</code></pre>

<pre><code class="language-sql">-- Audit trail trigger: Log all changes
CREATE TABLE audit_log (
    id SERIAL PRIMARY KEY,
    table_name VARCHAR(50),
    record_id INT,
    action VARCHAR(10),
    old_values JSONB,
    new_values JSONB,
    changed_by VARCHAR(100),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE OR REPLACE FUNCTION audit_product_changes()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'DELETE' THEN
        INSERT INTO audit_log (table_name, record_id, action, old_values, changed_by)
        VALUES ('products', OLD.id, 'DELETE', to_jsonb(OLD), current_user);
        RETURN OLD;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO audit_log (table_name, record_id, action, old_values, new_values, changed_by)
        VALUES ('products', NEW.id, 'UPDATE', to_jsonb(OLD), to_jsonb(NEW), current_user);
        RETURN NEW;
    ELSIF TG_OP = 'INSERT' THEN
        INSERT INTO audit_log (table_name, record_id, action, new_values, changed_by)
        VALUES ('products', NEW.id, 'INSERT', to_jsonb(NEW), current_user);
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_products
    AFTER INSERT OR UPDATE OR DELETE ON products
    FOR EACH ROW
    EXECUTE FUNCTION audit_product_changes();
</code></pre>

                    <h3 id="event-driven">Event-Driven SQL Patterns</h3>
                    
                    <div class="experiment-card">
                        <h4><i class="fas fa-sitemap me-2"></i>Trigger Timing & Types</h4>
                        <div class="content">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timing</th>
                                        <th>Description</th>
                                        <th>Use Case</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>BEFORE</code></td>
                                        <td>Runs before the operation</td>
                                        <td>Validation, data transformation, auto-fill columns</td>
                                    </tr>
                                    <tr>
                                        <td><code>AFTER</code></td>
                                        <td>Runs after the operation</td>
                                        <td>Audit logs, notifications, cascade updates</td>
                                    </tr>
                                    <tr>
                                        <td><code>INSTEAD OF</code></td>
                                        <td>Replaces the operation (views)</td>
                                        <td>Making views updatable</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <table class="table table-bordered mt-3">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Level</th>
                                        <th>Fires</th>
                                        <th>Access</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>FOR EACH ROW</code></td>
                                        <td>Once per affected row</td>
                                        <td>OLD and NEW row values</td>
                                    </tr>
                                    <tr>
                                        <td><code>FOR EACH STATEMENT</code></td>
                                        <td>Once per SQL statement</td>
                                        <td>No row access</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
<pre><code class="language-sql">-- Business rule enforcement trigger
CREATE OR REPLACE FUNCTION check_order_total()
RETURNS TRIGGER AS $$
BEGIN
    -- Prevent orders over credit limit
    IF NEW.total > (
        SELECT credit_limit FROM customers WHERE id = NEW.customer_id
    ) THEN
        RAISE EXCEPTION 'Order total exceeds credit limit';
    END IF;
    
    -- Auto-apply loyalty discount
    IF (SELECT loyalty_tier FROM customers WHERE id = NEW.customer_id) = 'Gold' THEN
        NEW.discount = GREATEST(NEW.discount, 0.10);  -- At least 10% for Gold members
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_order
    BEFORE INSERT OR UPDATE ON orders
    FOR EACH ROW
    EXECUTE FUNCTION check_order_total();
</code></pre>
                    
                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Trigger Warnings:</strong>
                        <ul style="margin-top: 10px;">
                            <li>Triggers are <strong>hidden logic</strong>—developers may not know they exist</li>
                            <li>Cascading triggers can cause <strong>infinite loops</strong></li>
                            <li>They add <strong>overhead</strong> to every write operation</li>
                            <li>Hard to <strong>debug</strong>—no breakpoints, limited logging</li>
                            <li>Consider <strong>application-level logic</strong> for complex business rules</li>
                        </ul>
                    </div>
                </div>

                <!-- JSON Support Section -->
                <div id="json-support" class="blog-content mt-5">
                    <h2><i class="fas fa-code me-2 text-teal"></i>JSON Support in SQL</h2>
                    
                    <p>Modern relational databases (PostgreSQL, MySQL 5.7+, SQL Server 2016+) support JSON natively. This bridges the gap between structured relational data and semi-structured document data.</p>
                    
                    <div class="highlight-box">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>When to Use JSON Columns:</strong>
                        <ul style="margin-top: 10px;">
                            <li>Schema varies per row (custom attributes, settings, metadata)</li>
                            <li>Data from external APIs stored as-is</li>
                            <li>Prototyping before schema solidifies</li>
                            <li>Audit logs with varying structure</li>
                        </ul>
                    </div>
                    
<pre><code class="language-sql">-- PostgreSQL JSON support (json vs jsonb)
CREATE TABLE products_extended (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    base_price DECIMAL(10,2),
    attributes JSONB  -- Use JSONB for better performance (binary, indexable)
);

INSERT INTO products_extended (name, base_price, attributes) VALUES
    ('Laptop', 999.99, '{"brand": "Dell", "ram_gb": 16, "storage": {"type": "SSD", "size_gb": 512}}'),
    ('Mouse', 29.99, '{"brand": "Logitech", "wireless": true, "dpi": 12000}'),
    ('Monitor', 349.99, '{"brand": "LG", "size_inches": 27, "resolution": "4K", "panel": "IPS"}');

-- Accessing JSON values
SELECT 
    name,
    attributes->>'brand' AS brand,                    -- Text extraction
    (attributes->>'ram_gb')::INT AS ram,             -- Cast to integer
    attributes->'storage'->>'type' AS storage_type   -- Nested access
FROM products_extended;

-- Filtering on JSON values
SELECT name, attributes
FROM products_extended
WHERE attributes->>'brand' = 'Dell'
   OR (attributes->>'wireless')::BOOLEAN = true;

-- JSON path queries (PostgreSQL 12+)
SELECT name, attributes
FROM products_extended
WHERE attributes @? '$.storage.type ? (@ == "SSD")';
</code></pre>

<pre><code class="language-sql">-- Modifying JSON data
UPDATE products_extended
SET attributes = attributes || '{"warranty_years": 2}'  -- Add field
WHERE name = 'Laptop';

UPDATE products_extended
SET attributes = attributes - 'wireless'  -- Remove field
WHERE name = 'Mouse';

UPDATE products_extended  
SET attributes = jsonb_set(attributes, '{storage,size_gb}', '1024')  -- Update nested
WHERE name = 'Laptop';

-- Indexing JSON for performance
CREATE INDEX idx_product_brand 
ON products_extended ((attributes->>'brand'));

CREATE INDEX idx_product_attrs 
ON products_extended USING GIN (attributes);  -- Indexes entire JSON structure
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-database me-2"></i>JSON Operators Quick Reference (PostgreSQL)</h4>
                        <div class="content">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Operator</th>
                                        <th>Returns</th>
                                        <th>Example</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>-></code></td>
                                        <td>JSON object</td>
                                        <td><code>data->'key'</code> → <code>{"nested": "value"}</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>->></code></td>
                                        <td>Text value</td>
                                        <td><code>data->>'key'</code> → <code>value</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>#></code></td>
                                        <td>JSON at path</td>
                                        <td><code>data#>'{a,b}'</code> → nested JSON</td>
                                    </tr>
                                    <tr>
                                        <td><code>#>></code></td>
                                        <td>Text at path</td>
                                        <td><code>data#>>'{a,b}'</code> → nested text</td>
                                    </tr>
                                    <tr>
                                        <td><code>@></code></td>
                                        <td>Contains</td>
                                        <td><code>data @> '{"key": "val"}'</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>?</code></td>
                                        <td>Has key</td>
                                        <td><code>data ? 'key'</code></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
<pre><code class="language-sql">-- MySQL JSON support
SELECT 
    name,
    JSON_EXTRACT(attributes, '$.brand') AS brand,
    JSON_UNQUOTE(JSON_EXTRACT(attributes, '$.brand')) AS brand_unquoted
FROM products_extended;

-- MySQL shorthand (-> and ->> operators)
SELECT 
    name,
    attributes->'$.brand' AS brand,          -- Returns JSON string (quoted)
    attributes->>'$.brand' AS brand_text     -- Returns unquoted text
FROM products_extended;

-- SQL Server JSON support
SELECT 
    name,
    JSON_VALUE(attributes, '$.brand') AS brand,
    JSON_QUERY(attributes, '$.storage') AS storage_object
FROM products_extended;
</code></pre>
                    
                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>JSON Anti-Patterns:</strong>
                        <ul style="margin-top: 10px;">
                            <li><strong>Don't store queryable data in JSON</strong> if you frequently filter/join on it</li>
                            <li><strong>Don't use JSON to avoid proper schema design</strong>—normalization exists for good reasons</li>
                            <li><strong>Don't forget indexing</strong>—unindexed JSON queries can be very slow</li>
                            <li>Consider <strong>document databases</strong> (MongoDB, see Part 8) if your data is mostly semi-structured</li>
                        </ul>
                    </div>
                </div>

                <!-- Production SQL Section -->
                <div id="production-sql" class="blog-content mt-5">
                    <h2><i class="fas fa-industry me-2 text-teal"></i>Production-Grade SQL Patterns</h2>
                    
                    <p>Writing SQL that works in development is easy. Writing SQL that performs well with millions of rows, handles concurrent users, and doesn't break under edge cases—that's the challenge. Here are battle-tested patterns.</p>
                    
                    <h3>Pagination That Scales</h3>
                    
<pre><code class="language-sql">-- ❌ BAD: OFFSET gets slower as pages increase
-- Page 10,000 reads 100,000 rows to skip 99,990!
SELECT * FROM products
ORDER BY id
LIMIT 10 OFFSET 99990;

-- ✅ GOOD: Keyset pagination (cursor-based)
-- "Give me 10 products after ID 99990"
SELECT * FROM products
WHERE id > 99990
ORDER BY id
LIMIT 10;

-- For multi-column sorting
SELECT * FROM products
WHERE (created_at, id) > ('2024-01-15 10:30:00', 12345)
ORDER BY created_at, id
LIMIT 10;
</code></pre>

                    <h3>Upsert (Insert or Update)</h3>
                    
<pre><code class="language-sql">-- PostgreSQL UPSERT (INSERT ... ON CONFLICT)
INSERT INTO products (sku, name, price, stock)
VALUES ('LAPTOP-001', 'Gaming Laptop', 1299.99, 50)
ON CONFLICT (sku) DO UPDATE SET
    price = EXCLUDED.price,
    stock = products.stock + EXCLUDED.stock,  -- Add to existing stock
    updated_at = CURRENT_TIMESTAMP;

-- MySQL UPSERT (INSERT ... ON DUPLICATE KEY)
INSERT INTO products (sku, name, price, stock)
VALUES ('LAPTOP-001', 'Gaming Laptop', 1299.99, 50)
ON DUPLICATE KEY UPDATE
    price = VALUES(price),
    stock = stock + VALUES(stock),
    updated_at = CURRENT_TIMESTAMP;
</code></pre>

                    <h3>Batch Operations</h3>
                    
<pre><code class="language-sql">-- ❌ BAD: 10,000 separate INSERT statements
-- Each is a network round-trip + transaction
FOR i IN 1..10000:
    INSERT INTO logs (message) VALUES ('Log ' + i);

-- ✅ GOOD: Batch insert
INSERT INTO logs (message)
VALUES 
    ('Log 1'), ('Log 2'), ('Log 3'), 
    -- ... batch of 1000 at a time
    ('Log 1000');

-- ✅ GOOD: COPY for bulk loading (PostgreSQL)
COPY products (sku, name, price)
FROM '/data/products.csv'
WITH (FORMAT csv, HEADER true);

-- ✅ GOOD: Large UPDATE in batches (avoid locking entire table)
DO $$
DECLARE
    rows_updated INT;
BEGIN
    LOOP
        UPDATE products 
        SET status = 'archived'
        WHERE id IN (
            SELECT id FROM products 
            WHERE last_sold < '2020-01-01' AND status = 'active'
            LIMIT 1000
        );
        
        GET DIAGNOSTICS rows_updated = ROW_COUNT;
        EXIT WHEN rows_updated = 0;
        
        COMMIT;  -- Release locks between batches
        PERFORM pg_sleep(0.1);  -- Brief pause
    END LOOP;
END $$;
</code></pre>

                    <h3>Safe Schema Migrations</h3>
                    
<pre><code class="language-sql">-- Adding a column with default (PostgreSQL 11+)
-- This is instant, no table rewrite!
ALTER TABLE orders 
ADD COLUMN priority VARCHAR(20) DEFAULT 'normal';

-- For older PostgreSQL or other DBs, add column then backfill
ALTER TABLE orders ADD COLUMN priority VARCHAR(20);
-- Backfill in batches (see above pattern)
UPDATE orders SET priority = 'normal' WHERE priority IS NULL;
ALTER TABLE orders ALTER COLUMN priority SET DEFAULT 'normal';

-- Adding an index without blocking writes (PostgreSQL)
CREATE INDEX CONCURRENTLY idx_orders_customer
ON orders (customer_id);

-- Safe column rename pattern
-- 1. Add new column
ALTER TABLE users ADD COLUMN full_name VARCHAR(200);
-- 2. Backfill
UPDATE users SET full_name = first_name || ' ' || last_name;
-- 3. Update application code to use new column
-- 4. Drop old columns after deployment verified
ALTER TABLE users DROP COLUMN first_name, DROP COLUMN last_name;
</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-shield-alt me-2"></i>Production SQL Checklist</h4>
                        <div class="content">
                            <ul>
                                <li>☐ <strong>EXPLAIN ANALYZE</strong> run on production-like data?</li>
                                <li>☐ <strong>Indexes</strong> exist for all WHERE and JOIN conditions?</li>
                                <li>☐ <strong>LIMIT</strong> included to prevent unbounded result sets?</li>
                                <li>☐ <strong>Timeouts</strong> configured for long-running queries?</li>
                                <li>☐ <strong>Transactions</strong> wrapped appropriately (BEGIN/COMMIT)?</li>
                                <li>☐ <strong>Parameterized queries</strong> used (no SQL injection)?</li>
                                <li>☐ <strong>Connection pooling</strong> in place?</li>
                                <li>☐ <strong>Read replicas</strong> used for reporting queries?</li>
                                <li>☐ <strong>Monitoring</strong> in place for slow queries?</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="highlight-box">
                        <i class="fas fa-book me-2"></i>
                        <strong>Deep Dive:</strong> Query optimization and indexing strategies are covered extensively in <a href="database-mastery-query-optimization.html">Part 6: Query Optimization & Indexing</a>.
                    </div>
                </div>

                <!-- Conclusion -->
                <div id="conclusion" class="blog-content mt-5">
                    <h2><i class="fas fa-flag-checkered me-2 text-teal"></i>Conclusion & Next Steps</h2>
                    
                    <p>You've now mastered advanced SQL techniques that form the backbone of complex data operations. CTEs, window functions, and stored procedures are essential tools for any serious database developer.</p>

                    <div class="series-next">
                        <h4><i class="fas fa-arrow-right me-2"></i>Next in the Series</h4>
                        <p>In <a href="database-mastery-postgresql.html"><strong>Part 3: PostgreSQL Deep Dive</strong></a>, we'll explore the most powerful open-source RDBMS—advanced data types, indexing strategies, extensions, and performance tuning.</p>
                    </div>
                </div>

                <!-- Related Posts -->
                <div class="related-posts">
                    <h3><i class="fas fa-book me-2"></i>Continue the Database Mastery Series</h3>
                    <div class="related-post-item">
                        <h5>Part 1: SQL Fundamentals & Syntax</h5>
                        <p>Review the fundamentals: CRUD operations, joins, constraints, and SQL basics.</p>
                        <a href="database-mastery-sql-fundamentals.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                    <div class="related-post-item">
                        <h5>Part 3: PostgreSQL Deep Dive</h5>
                        <p>Explore PostgreSQL's advanced features, data types, indexing, and performance tuning.</p>
                        <a href="database-mastery-postgresql.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                    <div class="related-post-item">
                        <h5>Part 6: Query Optimization & Indexing</h5>
                        <p>Master EXPLAIN plans, index design, and performance optimization techniques.</p>
                        <a href="database-mastery-query-optimization.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                </div>

                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="social-media" class="bg-dark text-light py-5">
        <div class="container py-5">
            <div class="row mb-4">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <h5 class="fw-bold mb-3">Let's Connect</h5>
                    <p class="text-light">
                        I'm always interested in sharing content about my interests on different topics. Read disclaimer and feel free to share further.
                    </p>
                </div>
                <div class="col-lg-6">
                    <h5 class="fw-bold mb-3">Follow Me</h5>
                    <div class="social-links d-flex gap-2 flex-wrap">
                        <a href="https://www.facebook.com/wasil.zafar/" target="_blank" class="social-icon" title="Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://twitter.com/wasilzafar" target="_blank" class="social-icon" title="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://www.linkedin.com/in/wasilzafar" target="_blank" class="social-icon" title="LinkedIn">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                        <a href="https://www.youtube.com/@wasilzafar" target="_blank" class="social-icon" title="YouTube">
                            <i class="fab fa-youtube"></i>
                        </a>
                        <a href="https://www.instagram.com/itswzee/" target="_blank" class="social-icon" title="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://in.pinterest.com/wasilz/" target="_blank" class="social-icon" title="Pinterest">
                            <i class="fab fa-pinterest-p"></i>
                        </a>
                        <a href="mailto:wasil.zafar@gmail.com" class="social-icon" title="Email">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                </div>
            </div>

            <hr class="bg-secondary">

            <div class="row mt-4">
                <div class="col-md-6">
                    <p class="small">
                        <i class="fas fa-icons me-2"></i>Icons from <a href="https://www.flaticon.com/" target="_blank" class="text-light">Flaticon</a> &amp; <a href="https://fontawesome.com/" target="_blank" class="text-light">Font Awesome</a>
                    </p>
                    <p class="small mt-3">
                        <a href="/" class="text-light text-decoration-none">Home</a> | 
                        <a href="/disclaimer.html" class="text-light text-decoration-none">Disclaimer</a> | 
                        <a href="/privacy-policy.html" class="text-light text-decoration-none">Privacy Policy</a>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small">
                        Enjoying this content?  <a href="https://buymeacoffee.com/itswzee" target="_blank" class="text-light" style="text-decoration: underline;">Keep me caffeinated</a> to keep the pixels flowing!
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll-to-Top Button -->
    <button id="scrollToTop" class="scroll-to-top" title="Back to Top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Category Indicator -->
    <div id="categoryIndicator" class="category-indicator" title="Current Section"><i class="fas fa-tag"></i><span id="categoryText">Technology</span></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../../../js/main.js"></script>
    <script src="../../../js/cookie-consent.js"></script>
    
    <!-- Prism.js for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <!-- Prism Theme Switcher -->
    <script>
        const themes = {
            'prism-theme': 'Tomorrow Night',
            'prism-default': 'Default',
            'prism-dark': 'Dark',
            'prism-twilight': 'Twilight',
            'prism-okaidia': 'Okaidia',
            'prism-solarizedlight': 'Solarized Light'
        };

        const savedTheme = localStorage.getItem('prism-theme') || 'prism-theme';

        function switchTheme(themeId) {
            Object.keys(themes).forEach(id => {
                const link = document.getElementById(id);
                if (link) link.disabled = true;
            });
            
            const selectedLink = document.getElementById(themeId);
            if (selectedLink) {
                selectedLink.disabled = false;
                localStorage.setItem('prism-theme', themeId);
            }

            document.querySelectorAll('div.code-toolbar select').forEach(dropdown => {
                dropdown.value = themeId;
            });

            setTimeout(() => Prism.highlightAll(), 10);
        }

        document.addEventListener('DOMContentLoaded', function() {
            switchTheme(savedTheme);
        });

        Prism.plugins.toolbar.registerButton('theme-switcher', function(env) {
            const select = document.createElement('select');
            select.setAttribute('aria-label', 'Select code theme');
            select.className = 'prism-theme-selector';
            
            Object.keys(themes).forEach(themeId => {
                const option = document.createElement('option');
                option.value = themeId;
                option.textContent = themes[themeId];
                if (themeId === savedTheme) option.selected = true;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function(e) {
                switchTheme(e.target.value);
            });
            
            return select;
        });
    </script>

    <!-- Scroll-to-Top and Category Indicator Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            const categoryIndicator = document.getElementById('categoryIndicator');
            
            const h2Elements = document.querySelectorAll('.blog-content h2');
            const sections = [];
            
            h2Elements.forEach(function(h2) {
                let text = h2.textContent.trim().replace(/^\d+\.\s*/, '');
                if (text.length > 25) text = text.substring(0, 22) + '...';
                sections.push({ element: h2, name: text });
            });
            
            window.addEventListener('scroll', function() {
                if (window.scrollY > 300) {
                    scrollToTopBtn.classList.add('show');
                    
                    if (sections.length > 0) {
                        let currentSection = sections[0].name;
                        for (let i = 0; i < sections.length; i++) {
                            const rect = sections[i].element.getBoundingClientRect();
                            if (rect.top <= 150) currentSection = sections[i].name;
                        }
                        categoryIndicator.textContent = currentSection;
                        categoryIndicator.classList.add('show');
                    }
                } else {
                    scrollToTopBtn.classList.remove('show');
                    categoryIndicator.classList.remove('show');
                }
            });
            
            scrollToTopBtn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    </script>
</body>
</html>
