<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="robots" content="index, archive" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Part 4: Assembly Language & Machine Code - Learn about CPU registers, stack operations, calling conventions, and practical assembly examples." />
    <meta name="keywords" content="assembly language, machine code, registers, stack, calling conventions, x86 assembly, ARM assembly, low-level programming" />
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Part 4: Assembly Language & Machine Code | Computer Architecture & OS Mastery" />
    <meta property="og:description" content="Master assembly fundamentals: registers, stack operations, calling conventions, and practical examples." />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://wasilzafar.com/pages/series/computer-architecture/comp-arch-assembly.html" />
    <meta property="article:published_time" content="2026-01-31" />
    <meta property="article:author" content="Wasil Zafar" />
    <meta property="article:section" content="Technology" />

    <title>Part 4: Assembly Language & Machine Code | Computer Architecture & OS Mastery - Wasil Zafar</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" />

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../../images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../images/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="../../../images/favicon_io/site.webmanifest">

    <!-- Prism.js Syntax Highlighting - Multiple Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" id="prism-theme" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" id="prism-default" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" id="prism-dark" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-twilight.min.css" id="prism-twilight" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" id="prism-okaidia" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-solarizedlight.min.css" id="prism-solarizedlight" disabled />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" />

    <!-- Google Consent Mode v2 -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'analytics_storage': 'denied',
            'region': ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE']
        });
        gtag('consent', 'default', {
            'ad_storage': 'granted',
            'ad_user_data': 'granted',
            'ad_personalization': 'granted',
            'analytics_storage': 'granted'
        });
        gtag('set', 'url_passthrough', true);
    </script>

    <!-- Google Tag Manager -->
    <script>
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-PBS8M2JR');
    </script>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PBS8M2JR" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>

    <!-- GDPR Cookie Consent Banner -->
    <div id="cookieBanner" class="light display-bottom" style="display: none;">
        <div id="closeIcon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"></path>
            </svg>
        </div>
        
        <div class="content-wrap">
            <div class="msg-wrap">
                <div class="title-wrap">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20">
                        <path fill="#3B9797" d="M510.52 255.82c-69.97-.85-126.47-57.69-126.47-127.86-70.17 0-127-56.49-127.86-126.45-27.26-4.14-55.13.3-79.72 12.82l-69.13 35.22a132.221 132.221 0 0 0-57.79 57.81l-35.1 68.88a132.645 132.645 0 0 0-12.82 80.95l12.08 76.27a132.521 132.521 0 0 0 37.16 70.37l54.64 54.64a132.036 132.036 0 0 0 70.37 37.16l76.27 12.15c27.51 4.36 55.7-.11 80.95-12.8l68.88-35.08a132.166 132.166 0 0 0 57.79-57.81l35.1-68.88c12.56-24.64 17.01-52.58 12.91-79.91zM176 368c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm32-160c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm160 128c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32z"></path>
                    </svg>
                    <h4 style="margin: 0; font-size: 18px; color: var(--color-navy); font-weight: 700;">Cookie Consent</h4>
                </div>
                <p style="font-size: 14px; line-height: 1.6; color: var(--color-navy); margin-bottom: 15px;">
                    We use cookies to enhance your browsing experience, serve personalized content, and analyze our traffic. 
                    By clicking "Accept All", you consent to our use of cookies. See our 
                    <a href="/privacy-policy.html" style="color: var(--color-teal); border-bottom: 1px dotted var(--color-teal);">Privacy Policy</a> 
                    for more information.
                </p>
                
                <div id="cookieSettings" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14">
                        <path fill="currentColor" d="M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47 0-70.2l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10-5.1-14.8-2.3L380.8 110c-17.9-15.4-38.5-27.3-60.8-35.1V25.8c0-5.6-3.9-10.5-9.4-11.7-36.7-8.2-74.3-7.8-109.2 0-5.5 1.2-9.4 6.1-9.4 11.7V75c-22.2 7.9-42.8 19.8-60.8 35.1L88.7 85.5c-4.9-2.8-11-1.9-14.8 2.3-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4.6 11.2 5.5 14L67.3 221c-4.3 23.2-4.3 47 0 70.2l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10 5.1 14.8 2.3l42.6-24.6c17.9 15.4 38.5 27.3 60.8 35.1v49.2c0 5.6 3.9 10.5 9.4 11.7 36.7 8.2 74.3 7.8 109.2 0 5.5-1.2 9.4-6.1 9.4-11.7v-49.2c22.2-7.9 42.8-19.8 60.8-35.1l42.6 24.6c4.9 2.8 11 1.9 14.8-2.3 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.5-.7-11.3-5.6-14.1zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z"></path>
                    </svg>
                    <span style="margin-left: 5px; font-size: 12px; font-weight: 600; color: var(--color-navy);">Customize Settings</span>
                </div>
                
                <div id="cookieTypes" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(59, 151, 151, 0.2);">
                    <h5 style="font-size: 12px; font-weight: 700; color: var(--color-navy); margin-bottom: 10px; text-transform: uppercase;">Cookie Preferences</h5>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" checked disabled style="margin-top: 2px; margin-right: 8px; cursor: not-allowed;">
                            <div>
                                <strong style="font-size: 13px; color: var(--color-navy); display: block; margin-bottom: 2px;">Essential Cookies (Required)</strong>
                                <span style="font-size: 12px; color: #666;">Necessary for the website to function properly.</span>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" id="analyticsCookies" checked style="margin-top: 2px; margin-right: 8px;">
                            <div>
                                <strong style="font-size: 13px; color: var(--color-navy); display: block; margin-bottom: 2px;">Analytics Cookies</strong>
                                <span style="font-size: 12px; color: #666;">Help us understand how you interact with the website.</span>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" id="marketingCookies" style="margin-top: 2px; margin-right: 8px;">
                            <div>
                                <strong style="font-size: 13px; color: var(--color-navy); display: block; margin-bottom: 2px;">Marketing Cookies</strong>
                                <span style="font-size: 12px; color: #666;">Used to deliver relevant advertisements.</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="btn-wrap">
                <button id="cookieAccept" style="background: var(--color-teal); color: white; font-weight: 600;">Accept All</button>
                <button id="cookieReject" style="background: transparent; color: var(--color-navy); border: 2px solid var(--color-teal); font-weight: 600;">Reject All</button>
                <button id="cookieSave" style="background: var(--color-blue); color: white; font-weight: 600; display: none;">Save Preferences</button>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <span class="gradient-text">Wasil Zafar</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#skills">Skills</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#certifications">Certifications</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#interests">Interests</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Blog Hero Section -->
    <section class="blog-hero">
        <div class="container py-5">
            <a href="../../categories/technology.html" class="back-link"><i class="fas fa-arrow-left me-2"></i>Back to Technology</a>
            <h1 class="display-4 fw-bold mt-4">Part 4: Assembly Language & Machine Code</h1>
            <div class="blog-meta">
                <span><i class="fas fa-calendar me-2"></i>January 31, 2026</span>
                <span><i class="fas fa-user me-2"></i>Wasil Zafar</span>
                <span class="reading-time"><i class="fas fa-clock me-1"></i>25 min read</span>
                <button onclick="window.print()" class="print-btn" title="Print this article"><i class="fas fa-print"></i> Print</button>
            </div>
            <p class="lead mt-3">Dive into the lowest level of programming—understanding registers, stack management, calling conventions, and writing assembly code.</p>
        </div>
    </section>

    <!-- Table of Contents Toggle Button -->
    <button class="toc-toggle-btn" onclick="openNav()" title="Table of Contents" aria-label="Open Table of Contents">
        <i class="fas fa-list"></i>
    </button>

    <!-- Side Navigation TOC -->
    <div id="tocSidenav" class="sidenav-toc">
        <div class="toc-header">
            <h3><i class="fas fa-list me-2"></i>Table of Contents</h3>
            <button class="closebtn" onclick="closeNav()" aria-label="Close Table of Contents">&times;</button>
        </div>
        <ol>
            <li>
                <a href="#introduction" onclick="closeNav()">Introduction</a>
            </li>
            <li>
                <a href="#registers" onclick="closeNav()">Registers</a>
                <ul>
                    <li><a href="#general-purpose" onclick="closeNav()">General Purpose Registers</a></li>
                    <li><a href="#special-registers" onclick="closeNav()">Special Registers</a></li>
                    <li><a href="#flags-register" onclick="closeNav()">Flags Register</a></li>
                </ul>
            </li>
            <li>
                <a href="#stack-operations" onclick="closeNav()">Stack Operations</a>
                <ul>
                    <li><a href="#push-pop" onclick="closeNav()">Push & Pop</a></li>
                    <li><a href="#stack-frames" onclick="closeNav()">Stack Frames</a></li>
                    <li><a href="#local-variables" onclick="closeNav()">Local Variables</a></li>
                </ul>
            </li>
            <li>
                <a href="#calling-conventions" onclick="closeNav()">Calling Conventions</a>
                <ul>
                    <li><a href="#cdecl" onclick="closeNav()">cdecl Convention</a></li>
                    <li><a href="#stdcall" onclick="closeNav()">stdcall Convention</a></li>
                    <li><a href="#system-v" onclick="closeNav()">System V ABI</a></li>
                </ul>
            </li>
            <li>
                <a href="#assembly-examples" onclick="closeNav()">Assembly Examples</a>
                <ul>
                    <li><a href="#x86-examples" onclick="closeNav()">x86 Examples</a></li>
                    <li><a href="#arm-examples" onclick="closeNav()">ARM Examples</a></li>
                    <li><a href="#debugging" onclick="closeNav()">Debugging Assembly</a></li>
                </ul>
            </li>
            <li><a href="#conclusion" onclick="closeNav()">Conclusion & Next Steps</a></li>
        </ol>
    </div>

    <div id="tocOverlay" class="sidenav-overlay" onclick="closeNav()"></div>

    <!-- Main Content -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">

                <!-- Introduction -->
                <div id="introduction" class="blog-content">
                    <h2><i class="fas fa-terminal me-2 text-teal"></i>Introduction</h2>
                    
                    <p>Assembly language provides a human-readable representation of machine code—the binary instructions that processors actually execute. Understanding assembly is essential for low-level debugging, performance optimization, and systems programming.</p>

                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-sitemap me-2"></i>
                        <strong>Series Context:</strong> This is <strong>Part 4 of 24</strong> in the Computer Architecture & Operating Systems Mastery series. Building on ISA concepts, we now learn to write and read assembly code.
                    </div>

                    <div class="experiment-card" id="series-nav">
                        <h4><i class="fas fa-map-signs me-2"></i>Complete Series Navigation</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-teal me-2">24-Part Series</span>
                            <span class="badge bg-crimson">Computer Architecture & OS Mastery</span>
                        </div>
                        <div class="content">
                            <ol>
                                <li><a href="comp-arch-foundations.html"><strong>Part 1:</strong> Foundations of Computer Systems</a> — System overview, architectures, OS role</li>
                                <li><a href="comp-arch-digital-logic.html"><strong>Part 2:</strong> Digital Logic & CPU Building Blocks</a> — Gates, registers, datapath, microarchitecture</li>
                                <li><a href="comp-arch-isa.html"><strong>Part 3:</strong> Instruction Set Architecture (ISA)</a> — RISC vs CISC, instruction formats, addressing</li>
                                <li><strong>Part 4: Assembly Language & Machine Code (This Guide)</strong> — Registers, stack, calling conventions</li>
                                <li><a href="comp-arch-linkers-loaders.html"><strong>Part 5:</strong> Assemblers, Linkers & Loaders</a> — Object files, ELF, dynamic linking</li>
                                <li><a href="comp-arch-compilers.html"><strong>Part 6:</strong> Compilers & Program Translation</a> — Lexing, parsing, code generation</li>
                                <li><a href="comp-arch-cpu-pipelining.html"><strong>Part 7:</strong> CPU Execution & Pipelining</a> — Fetch-decode-execute, hazards, prediction</li>
                                <li><a href="comp-arch-os-kernel.html"><strong>Part 8:</strong> OS Architecture & Kernel Design</a> — Monolithic, microkernel, system calls</li>
                                <li><a href="comp-arch-processes.html"><strong>Part 9:</strong> Processes & Program Execution</a> — Process lifecycle, PCB, fork/exec</li>
                                <li><a href="comp-arch-threads-concurrency.html"><strong>Part 10:</strong> Threads & Concurrency</a> — Threading models, pthreads, race conditions</li>
                                <li><a href="comp-arch-cpu-scheduling.html"><strong>Part 11:</strong> CPU Scheduling Algorithms</a> — FCFS, RR, CFS, real-time scheduling</li>
                                <li><a href="comp-arch-synchronization.html"><strong>Part 12:</strong> Synchronization & Coordination</a> — Locks, semaphores, classic problems</li>
                                <li><a href="comp-arch-deadlocks.html"><strong>Part 13:</strong> Deadlocks & Prevention</a> — Coffman conditions, Banker's algorithm</li>
                                <li><a href="comp-arch-cache-memory-hierarchy.html"><strong>Part 14:</strong> Memory Hierarchy & Cache</a> — L1/L2/L3, cache coherence, NUMA</li>
                                <li><a href="comp-arch-memory-management.html"><strong>Part 15:</strong> Memory Management Fundamentals</a> — Address spaces, fragmentation, allocation</li>
                                <li><a href="comp-arch-virtual-memory.html"><strong>Part 16:</strong> Virtual Memory & Paging</a> — Page tables, TLB, demand paging</li>
                                <li><a href="comp-arch-file-systems.html"><strong>Part 17:</strong> File Systems & Storage</a> — Inodes, journaling, ext4, NTFS</li>
                                <li><a href="comp-arch-io-devices.html"><strong>Part 18:</strong> I/O Systems & Device Drivers</a> — Interrupts, DMA, disk scheduling</li>
                                <li><a href="comp-arch-multiprocessor.html"><strong>Part 19:</strong> Multiprocessor Systems</a> — SMP, NUMA, cache coherence</li>
                                <li><a href="comp-arch-security.html"><strong>Part 20:</strong> OS Security & Protection</a> — Privilege levels, ASLR, sandboxing</li>
                                <li><a href="comp-arch-virtualization.html"><strong>Part 21:</strong> Virtualization & Containers</a> — Hypervisors, namespaces, cgroups</li>
                                <li><a href="comp-arch-kernel-internals.html"><strong>Part 22:</strong> Advanced Kernel Internals</a> — Linux subsystems, kernel debugging</li>
                                <li><a href="comp-arch-case-studies.html"><strong>Part 23:</strong> Case Studies</a> — Linux vs Windows vs macOS</li>
                                <li><a href="comp-arch-capstone-projects.html"><strong>Part 24:</strong> Capstone Projects</a> — Shell, thread pool, paging simulator</li>
                            </ol>
                        </div>
                    </div>

                    <!-- CONTENT PLACEHOLDER -->
                    <p>While high-level languages abstract away hardware details, assembly gives you direct control over the CPU. Every line translates to (usually) one machine instruction.</p>

                    <div class="experiment-card">
                        <h4><i class="fas fa-language me-2"></i>The Language Hierarchy</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-teal me-2">Concept Map</span>
                        </div>
                        <div class="content">
<pre><code class="language-text">High-level → Assembly → Machine Code → Hardware

C/Python:    Assembly:      Machine Code:    CPU Action:
─────────    ─────────      ────────────     ───────────
x = a + b    MOV EAX, [a]   8B 45 F8        Load from memory
             ADD EAX, [b]   03 45 FC        Add from memory  
             MOV [x], EAX   89 45 F4        Store to memory

Each level adds abstraction, hiding complexity from the programmer.</code></pre>
                        </div>
                    </div>

                    <h3>Why Learn Assembly?</h3>
                    <ul>
                        <li><strong>Debugging</strong> — Understand crash dumps and core files</li>
                        <li><strong>Performance</strong> — Identify bottlenecks at the instruction level</li>
                        <li><strong>Security</strong> — Analyze malware, write exploits, understand vulnerabilities</li>
                        <li><strong>Systems Programming</strong> — Write bootloaders, OS kernels, device drivers</li>
                        <li><strong>Reverse Engineering</strong> — Understand compiled binaries</li>
                    </ul>

                </div>

                <!-- Registers Section -->
                <div id="registers" class="blog-content mt-5">
                    <h2><i class="fas fa-memory me-2 text-teal"></i>Registers</h2>
                    
                    <p>Registers are the CPU's fastest storage—tiny but incredibly fast memory cells built directly into the processor. Understanding registers is fundamental to assembly programming.</p>

                    <h3 id="general-purpose">x86-64 General Purpose Registers</h3>

<pre><code class="language-text">x86-64 Register Architecture:

┌──────────────────────────────────────────────────────────────────────┐
│                         64-bit RAX                                    │
├───────────────────────────────────┬──────────────────────────────────┤
│           (high 32 bits)          │            EAX (32-bit)          │
│                                   ├─────────────────┬────────────────┤
│                                   │                 │   AX (16-bit)  │
│                                   │                 ├────────┬───────┤
│                                   │                 │AH (8b) │AL (8b)│
└───────────────────────────────────┴─────────────────┴────────┴───────┘
  Bits 63-32 (not directly named)    Bits 31-16        15-8     7-0

All 16 general-purpose registers:
┌────────────────┬────────────────┬─────────────────────────────────────┐
│   64-bit       │   32-bit       │   Common Usage                      │
├────────────────┼────────────────┼─────────────────────────────────────┤
│   RAX          │   EAX          │   Accumulator, return value         │
│   RBX          │   EBX          │   Base (callee-saved)               │
│   RCX          │   ECX          │   Counter, 4th argument             │
│   RDX          │   EDX          │   Data, 3rd argument                │
│   RSI          │   ESI          │   Source index, 2nd argument        │
│   RDI          │   EDI          │   Destination index, 1st argument   │
│   RBP          │   EBP          │   Base pointer (frame pointer)      │
│   RSP          │   ESP          │   Stack pointer                     │
│   R8-R15       │   R8D-R15D     │   Extended registers (64-bit mode)  │
└────────────────┴────────────────┴─────────────────────────────────────┘</code></pre>

                    <div class="highlight-box">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Important:</strong> Writing to a 32-bit register (like EAX) automatically zeros the upper 32 bits of the corresponding 64-bit register (RAX). Writing to 8-bit or 16-bit parts does NOT zero upper bits!
                    </div>

                    <h3 id="special-registers">Special Registers</h3>

<pre><code class="language-text">Special Purpose Registers:

┌──────────────┬─────────────────────────────────────────────────────────┐
│   Register   │   Purpose                                               │
├──────────────┼─────────────────────────────────────────────────────────┤
│   RIP        │   Instruction Pointer - address of NEXT instruction     │
│              │   Cannot be directly modified (use JMP, CALL, RET)      │
├──────────────┼─────────────────────────────────────────────────────────┤
│   RSP        │   Stack Pointer - top of the stack                      │
│              │   Modified by PUSH, POP, CALL, RET                      │
├──────────────┼─────────────────────────────────────────────────────────┤
│   RBP        │   Base Pointer - base of current stack frame            │
│              │   Used to access function parameters and locals         │
├──────────────┼─────────────────────────────────────────────────────────┤
│   RFLAGS     │   Status flags - result of operations (see below)       │
└──────────────┴─────────────────────────────────────────────────────────┘</code></pre>

                    <h3 id="flags-register">Flags Register (RFLAGS)</h3>

<pre><code class="language-text">RFLAGS Register - Status and Control Flags:

Bit:  │ 11│ 10│  9│  8│  7│  6│  5│  4│  3│  2│  1│  0│
      ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
Flag: │ OF│ DF│ IF│ TF│ SF│ ZF│  -│ AF│  -│ PF│  -│ CF│

Key Flags:
┌──────┬────────────────────┬─────────────────────────────────────────┐
│ Flag │ Name               │ Set When...                             │
├──────┼────────────────────┼─────────────────────────────────────────┤
│  ZF  │ Zero Flag          │ Result is zero                          │
│  SF  │ Sign Flag          │ Result is negative (MSB = 1)            │
│  CF  │ Carry Flag         │ Unsigned overflow/borrow                │
│  OF  │ Overflow Flag      │ Signed overflow                         │
│  PF  │ Parity Flag        │ Result has even number of 1 bits        │
└──────┴────────────────────┴─────────────────────────────────────────┘

Example: SUB EAX, EBX  (EAX = EAX - EBX)
  If result is 0:     ZF=1, SF=0
  If result is -5:    ZF=0, SF=1
  If unsigned overflow occurred: CF=1
  If signed overflow occurred:   OF=1</code></pre>

                    <div class="experiment-card">
                        <h4><i class="fas fa-code me-2"></i>Flags in Action: Conditional Jumps</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-teal me-2">Assembly Example</span>
                        </div>
                        <div class="content">
<pre><code class="language-text">; Compare and branch
CMP EAX, EBX      ; Computes EAX - EBX, sets flags, discards result

; Unsigned comparisons (use CF and ZF)
JA  label         ; Jump if Above (CF=0 AND ZF=0)
JB  label         ; Jump if Below (CF=1)
JE  label         ; Jump if Equal (ZF=1)
JNE label         ; Jump if Not Equal (ZF=0)

; Signed comparisons (use SF, OF, and ZF)
JG  label         ; Jump if Greater (signed)
JL  label         ; Jump if Less (signed)
JGE label         ; Jump if Greater or Equal
JLE label         ; Jump if Less or Equal</code></pre>
                        </div>
                    </div>

                </div>

                <!-- Stack Operations Section -->
                <div id="stack-operations" class="blog-content mt-5">
                    <h2><i class="fas fa-layer-group me-2 text-teal"></i>Stack Operations</h2>
                    
                    <p>The <strong>stack</strong> is a region of memory that grows downward (from high to low addresses). It's used for function calls, local variables, and saving registers.</p>

                    <h3 id="push-pop">Push & Pop</h3>

<pre><code class="language-text">PUSH and POP Operations:

PUSH RAX:                          POP RAX:
─────────                          ────────
1. RSP = RSP - 8                   1. RAX = [RSP]
2. [RSP] = RAX                     2. RSP = RSP + 8

Before PUSH:      After PUSH:      After POP:
                                   
Higher Addresses  Higher Addresses Higher Addresses
    │                 │                │
    │                 │                │
    ├─────────┤       ├─────────┤      ├─────────┤
RSP►│ old top │       │ old top │  RSP►│ old top │
    ├─────────┤   RSP►├─────────┤      ├─────────┤
    │         │       │   RAX   │      │  (old)  │
    │         │       ├─────────┤      │         │
Lower Addresses   Lower Addresses  Lower Addresses

Stack grows DOWN (toward lower addresses)!</code></pre>

                    <h3 id="stack-frames">Stack Frames</h3>
                    
                    <p>Each function call creates a <strong>stack frame</strong> (also called <strong>activation record</strong>) containing:</p>

<pre><code class="language-text">Stack Frame Structure (x86-64 System V ABI):

Higher Addresses
        │
        ├─────────────────┤
        │  Caller's Frame │
        ├─────────────────┤
        │ Return Address  │ ← Pushed by CALL instruction
        ├─────────────────┤
RBP ───►│ Saved RBP       │ ← Points to caller's RBP
        ├─────────────────┤
        │ Local var 1     │ ← RBP - 8
        ├─────────────────┤
        │ Local var 2     │ ← RBP - 16
        ├─────────────────┤
        │ Local var 3     │ ← RBP - 24
        ├─────────────────┤
        │ (padding/align) │
        ├─────────────────┤
RSP ───►│ (stack top)     │
        │                 │
Lower Addresses

Function Prologue (setup stack frame):
    push rbp           ; Save caller's base pointer
    mov  rbp, rsp      ; Set up our base pointer
    sub  rsp, 32       ; Allocate space for locals

Function Epilogue (cleanup):
    mov  rsp, rbp      ; Deallocate locals
    pop  rbp           ; Restore caller's base pointer
    ret                ; Return to caller</code></pre>

                    <h3 id="local-variables">Local Variables</h3>

<pre><code class="language-text">Accessing Local Variables:

C function:
int example(int a, int b) {
    int x = 10;      // Local variable
    int y = 20;      // Local variable
    return x + y + a + b;
}

Assembly (x86-64 System V):
example:
    push rbp
    mov  rbp, rsp
    sub  rsp, 16          ; Space for 2 ints (with alignment)
    
    ; a is in EDI, b is in ESI (first 2 integer args)
    mov  DWORD PTR [rbp-4], edi   ; Save a
    mov  DWORD PTR [rbp-8], esi   ; Save b
    
    mov  DWORD PTR [rbp-12], 10   ; x = 10
    mov  DWORD PTR [rbp-16], 20   ; y = 20
    
    mov  eax, [rbp-12]    ; Load x
    add  eax, [rbp-16]    ; + y
    add  eax, [rbp-4]     ; + a
    add  eax, [rbp-8]     ; + b
    
    leave                 ; mov rsp,rbp; pop rbp
    ret</code></pre>

                </div>

                <!-- Calling Conventions Section -->
                <div id="calling-conventions" class="blog-content mt-5">
                    <h2><i class="fas fa-phone-alt me-2 text-teal"></i>Calling Conventions</h2>
                    
                    <p>A <strong>calling convention</strong> defines how functions receive arguments and return values, and which registers must be preserved across calls.</p>

                    <h3 id="cdecl">cdecl Convention (32-bit x86)</h3>

<pre><code class="language-text">cdecl Calling Convention (Legacy 32-bit):

┌────────────────────────────────────────────────────────────────┐
│ Arguments:    Pushed right-to-left onto stack                  │
│ Return value: EAX (or EAX:EDX for 64-bit values)              │
│ Caller saves: EAX, ECX, EDX (can be trashed)                  │
│ Callee saves: EBX, ESI, EDI, EBP (must preserve)              │
│ Stack cleanup: Caller cleans up arguments                      │
└────────────────────────────────────────────────────────────────┘

Example: result = add(5, 3)

    push 3          ; Second argument (right to left)
    push 5          ; First argument
    call add        ; Call the function
    add  esp, 8     ; Caller cleans stack (2 args × 4 bytes)
    mov  [result], eax</code></pre>

                    <h3 id="system-v">System V AMD64 ABI (64-bit Linux/macOS)</h3>

<pre><code class="language-text">System V AMD64 Calling Convention:

┌───────────────────────────────────────────────────────────────────────┐
│ Integer/pointer arguments (in order):                                  │
│   1st: RDI    2nd: RSI    3rd: RDX    4th: RCX    5th: R8    6th: R9  │
│   Additional arguments pushed right-to-left on stack                   │
├───────────────────────────────────────────────────────────────────────┤
│ Floating-point arguments: XMM0-XMM7                                    │
├───────────────────────────────────────────────────────────────────────┤
│ Return value: RAX (integer), XMM0 (float)                              │
│               For 128-bit: RAX:RDX                                     │
├───────────────────────────────────────────────────────────────────────┤
│ Caller-saved (volatile):   RAX, RCX, RDX, RSI, RDI, R8-R11           │
│ Callee-saved (preserved):  RBX, RBP, R12-R15                          │
├───────────────────────────────────────────────────────────────────────┤
│ Stack alignment: 16-byte aligned before CALL                           │
│ Red zone: 128 bytes below RSP usable without adjusting RSP            │
└───────────────────────────────────────────────────────────────────────┘

Example: result = compute(a, b, c, d, e, f)

; Arguments: a=1, b=2, c=3, d=4, e=5, f=6
mov  edi, 1       ; a → RDI
mov  esi, 2       ; b → RSI  
mov  edx, 3       ; c → RDX
mov  ecx, 4       ; d → RCX
mov  r8d, 5       ; e → R8
mov  r9d, 6       ; f → R9
call compute
; Result in RAX</code></pre>

                    <div class="highlight-box highlight-crimson">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Stack Alignment Warning:</strong> The stack must be 16-byte aligned BEFORE the <code>CALL</code> instruction. Since <code>CALL</code> pushes an 8-byte return address, your function should ensure the stack is 8-mod-16 before calling other functions!
                    </div>

                    <h3 id="windows-x64">Windows x64 Calling Convention</h3>

<pre><code class="language-text">Windows x64 Calling Convention:

┌───────────────────────────────────────────────────────────────────────┐
│ Integer/pointer arguments (in order):                                  │
│   1st: RCX    2nd: RDX    3rd: R8    4th: R9                          │
│   Additional arguments pushed right-to-left on stack                   │
│   (Different from System V!)                                           │
├───────────────────────────────────────────────────────────────────────┤
│ Shadow space: Caller must reserve 32 bytes above return address       │
│               (Even if function has fewer than 4 arguments!)          │
├───────────────────────────────────────────────────────────────────────┤
│ Callee-saved: RBX, RBP, RDI, RSI, R12-R15, XMM6-XMM15                 │
└───────────────────────────────────────────────────────────────────────┘

Stack layout for Windows x64:
        ├─────────────┤
        │ arg 5+      │ ← If more than 4 args
        ├─────────────┤
        │ Shadow[3]   │ ← Reserved for R9
        ├─────────────┤
        │ Shadow[2]   │ ← Reserved for R8
        ├─────────────┤
        │ Shadow[1]   │ ← Reserved for RDX
        ├─────────────┤
        │ Shadow[0]   │ ← Reserved for RCX
        ├─────────────┤
RSP ───►│ Return addr │
        ├─────────────┤</code></pre>

                </div>

                <!-- Assembly Examples Section -->
                <div id="assembly-examples" class="blog-content mt-5">
                    <h2><i class="fas fa-code me-2 text-teal"></i>Practical Assembly Examples</h2>
                    
                    <h3 id="x86-examples">x86-64 Assembly Examples</h3>

<pre><code class="language-text">; Example 1: Simple function that adds two numbers
; int add(int a, int b) { return a + b; }

global add
section .text
add:
    ; a is in EDI, b is in ESI (System V)
    mov  eax, edi       ; Copy a to EAX
    add  eax, esi       ; EAX = a + b
    ret                 ; Return value in EAX


; Example 2: Loop - sum array elements
; int sum_array(int* arr, int count)

global sum_array
section .text
sum_array:
    ; RDI = arr pointer, ESI = count
    xor  eax, eax       ; sum = 0 (XOR is fast way to zero)
    test esi, esi       ; Check if count == 0
    jle  .done          ; If count <= 0, return 0
    
.loop:
    add  eax, [rdi]     ; sum += *arr
    add  rdi, 4         ; arr++ (4 bytes per int)
    dec  esi            ; count--
    jnz  .loop          ; Continue if count != 0
    
.done:
    ret


; Example 3: String length (like strlen)
; size_t my_strlen(const char* str)

global my_strlen
section .text
my_strlen:
    ; RDI = str pointer
    mov  rax, rdi       ; Copy pointer
    
.loop:
    cmp  BYTE [rax], 0  ; Is current char null?
    je   .done          ; If yes, exit
    inc  rax            ; Move to next char
    jmp  .loop          ; Continue
    
.done:
    sub  rax, rdi       ; length = end - start
    ret</code></pre>

                    <h3 id="arm-examples">ARM64 Assembly Examples</h3>

<pre><code class="language-text">; ARM64 Example: Add two numbers
; int add(int a, int b)

.global add
.text
add:
    // w0 = a, w1 = b (first two args)
    add w0, w0, w1      // w0 = a + b
    ret                 // Return (result in w0)


; ARM64 Example: Sum array
; int sum_array(int* arr, int count)

.global sum_array
.text
sum_array:
    // x0 = arr, w1 = count
    mov  w2, #0         // sum = 0
    cbz  w1, .done      // If count == 0, done
    
.loop:
    ldr  w3, [x0], #4   // Load *arr, then arr += 4
    add  w2, w2, w3     // sum += *arr
    subs w1, w1, #1     // count-- and set flags
    bne  .loop          // If count != 0, continue
    
.done:
    mov  w0, w2         // Return sum
    ret


; ARM64 Conditional execution
; max = (a > b) ? a : b

.global max
max:
    cmp  w0, w1         // Compare a and b
    csel w0, w0, w1, gt // Select a if greater, else b
    ret</code></pre>

                    <h3 id="debugging">Debugging Assembly with GDB</h3>

                    <div class="experiment-card">
                        <h4><i class="fas fa-bug me-2"></i>Essential GDB Commands for Assembly</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-navy me-2">Debugging</span>
                        </div>
                        <div class="content">
<pre><code class="language-bash"># Compile with debug symbols
gcc -g -o program program.c

# Start GDB
gdb ./program

# Useful commands:
(gdb) break main           # Set breakpoint at main
(gdb) run                  # Start program
(gdb) disassemble          # Show assembly of current function
(gdb) disassemble main     # Show assembly of specific function

(gdb) info registers       # Show all register values
(gdb) print $rax           # Print specific register
(gdb) print/x $rsp         # Print in hexadecimal

(gdb) x/10i $rip           # Examine 10 instructions from RIP
(gdb) x/4xg $rsp           # Examine 4 quad words at RSP
(gdb) x/s $rdi             # Examine string at RDI

(gdb) stepi                # Step one instruction
(gdb) nexti                # Step one instruction (skip calls)
(gdb) finish               # Run until function returns

(gdb) layout asm           # Show assembly view
(gdb) layout regs          # Show registers + source</code></pre>
                        </div>
                    </div>

                    <h3 id="exercises">Exercises</h3>
                    
                    <div class="experiment-card">
                        <h4><i class="fas fa-pencil-alt me-2"></i>Practice Exercises</h4>
                        <div class="meta mb-2">
                            <span class="badge bg-teal me-2">Hands-On</span>
                        </div>
                        <div class="content">
                            <ol>
                                <li><strong>Register Trace:</strong> What's in RAX after: <code>mov eax, -1</code>?</li>
                                <li><strong>Stack Analysis:</strong> Draw the stack after executing:
<pre><code class="language-text">push 1
push 2
push 3
pop rax
pop rbx</code></pre></li>
                                <li><strong>Write Assembly:</strong> Implement <code>int abs(int x)</code> in x86-64 assembly</li>
                                <li><strong>Calling Convention:</strong> How would you call <code>printf("%d %d", 10, 20)</code> in System V ABI?</li>
                                <li><strong>Reverse Engineering:</strong> What does this code do?
<pre><code class="language-text">xor eax, eax
.loop:
    cmp byte [rdi], 0
    je .done
    inc eax
    inc rdi
    jmp .loop
.done:
    ret</code></pre></li>
                            </ol>
                        </div>
                    </div>

                </div>

                <!-- Conclusion -->
                <div id="conclusion" class="blog-content mt-5">
                    <h2><i class="fas fa-flag-checkered me-2 text-teal"></i>Conclusion & Key Takeaways</h2>
                    
                    <p>You now have a solid foundation in assembly language—from registers and stack operations to calling conventions used in real systems.</p>

                    <div class="highlight-box highlight-navy">
                        <i class="fas fa-graduation-cap me-2"></i>
                        <strong>What You've Learned:</strong>
                        <ul class="mt-2 mb-0">
                            <li><strong>Registers</strong> — General purpose (RAX-R15), special (RIP, RSP, RBP), and flags</li>
                            <li><strong>Stack</strong> — Grows downward, PUSH/POP operations, stack frames</li>
                            <li><strong>Calling Conventions</strong> — System V (Linux/macOS) vs Windows x64</li>
                            <li><strong>x86-64 Assembly</strong> — Data movement, arithmetic, control flow</li>
                            <li><strong>ARM64 Assembly</strong> — RISC approach, conditional execution</li>
                            <li><strong>Debugging</strong> — Using GDB to analyze assembly code</li>
                        </ul>
                    </div>

                    <div class="series-next">
                        <h4><i class="fas fa-arrow-right me-2"></i>Next in the Series</h4>
                        <p>Continue to <a href="comp-arch-linkers-loaders.html"><strong>Part 5: Assemblers, Linkers & Loaders</strong></a> to learn how source code becomes executable programs through compilation, linking, and loading!</p>
                    </div>
                </div>

                <!-- Related Posts -->
                <div class="related-posts">
                    <h3><i class="fas fa-book me-2"></i>Continue the Computer Architecture & OS Series</h3>
                    <div class="related-post-item">
                        <h5>Part 3: Instruction Set Architecture (ISA)</h5>
                        <p>RISC vs CISC, instruction formats, addressing modes, x86 vs ARM.</p>
                        <a href="comp-arch-isa.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                    <div class="related-post-item">
                        <h5>Part 5: Assemblers, Linkers & Loaders</h5>
                        <p>Object files, ELF format, static and dynamic linking.</p>
                        <a href="comp-arch-linkers-loaders.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                    <div class="related-post-item">
                        <h5>Part 2: Digital Logic & CPU Building Blocks</h5>
                        <p>Logic gates, ALU, registers, datapath, and microarchitecture fundamentals.</p>
                        <a href="comp-arch-digital-logic.html">Read Article <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                </div>

                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="social-media" class="bg-dark text-light py-5">
        <div class="container py-5">
            <div class="row mb-4">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <h5 class="fw-bold mb-3">Let's Connect</h5>
                    <p class="text-light">I'm always interested in sharing content about my interests on different topics. Read disclaimer and feel free to share further.</p>
                </div>
                <div class="col-lg-6">
                    <h5 class="fw-bold mb-3">Follow Me</h5>
                    <div class="social-links d-flex gap-2 flex-wrap">
                        <a href="https://www.facebook.com/wasil.zafar/" target="_blank" class="social-icon" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com/wasilzafar" target="_blank" class="social-icon" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.linkedin.com/in/wasilzafar" target="_blank" class="social-icon" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@wasilzafar" target="_blank" class="social-icon" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://www.instagram.com/itswzee/" target="_blank" class="social-icon" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="mailto:wasil.zafar@gmail.com" class="social-icon" title="Email"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
            </div>
            <hr class="bg-secondary">
            <div class="row mt-4">
                <div class="col-md-6">
                    <p class="small"><i class="fas fa-icons me-2"></i>Icons from <a href="https://fontawesome.com/" target="_blank" class="text-light">Font Awesome</a></p>
                    <p class="small mt-3">
                        <a href="/" class="text-light text-decoration-none">Home</a> | 
                        <a href="/disclaimer.html" class="text-light text-decoration-none">Disclaimer</a> | 
                        <a href="/privacy-policy.html" class="text-light text-decoration-none">Privacy Policy</a>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small">Enjoying this content? <a href="https://buymeacoffee.com/itswzee" target="_blank" class="text-light" style="text-decoration: underline;">Keep me caffeinated</a> to keep the pixels flowing!</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll-to-Top Button -->
    <button id="scrollToTop" class="scroll-to-top" title="Back to Top"><i class="fas fa-arrow-up"></i></button>

    <!-- Category Indicator -->
    <div id="categoryIndicator" class="category-indicator"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../../../js/main.js"></script>
    <script src="../../../js/cookie-consent.js"></script>
    
    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-asm6502.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <!-- Prism Theme Switcher -->
    <script>
        const themes = {
            'prism-theme': 'Tomorrow Night',
            'prism-default': 'Default',
            'prism-dark': 'Dark',
            'prism-twilight': 'Twilight',
            'prism-okaidia': 'Okaidia',
            'prism-solarizedlight': 'Solarized Light'
        };
        const savedTheme = localStorage.getItem('prism-theme') || 'prism-theme';
        function switchTheme(themeId) {
            Object.keys(themes).forEach(id => {
                const link = document.getElementById(id);
                if (link) link.disabled = true;
            });
            const selectedLink = document.getElementById(themeId);
            if (selectedLink) {
                selectedLink.disabled = false;
                localStorage.setItem('prism-theme', themeId);
            }
            document.querySelectorAll('div.code-toolbar select').forEach(dropdown => {
                dropdown.value = themeId;
            });
            setTimeout(() => Prism.highlightAll(), 10);
        }
        document.addEventListener('DOMContentLoaded', function() { switchTheme(savedTheme); });
        Prism.plugins.toolbar.registerButton('theme-switcher', function(env) {
            const select = document.createElement('select');
            select.setAttribute('aria-label', 'Select code theme');
            Object.keys(themes).forEach(themeId => {
                const option = document.createElement('option');
                option.value = themeId;
                option.textContent = themes[themeId];
                if (themeId === savedTheme) option.selected = true;
                select.appendChild(option);
            });
            select.addEventListener('change', function(e) { switchTheme(e.target.value); });
            return select;
        });
    </script>
</body>
</html>
